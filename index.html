<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Arena: beta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon-blue: #06b6d4; --neon-pink: #d946ef; --neon-gold: #fbbf24; }
        body {
            background-color: #020617; margin: 0; overflow: hidden; font-family: 'Rajdhani', sans-serif;
            user-select: none; display: flex; align-items: center; justify-content: center; height: 100vh; color: white;
            background-image: radial-gradient(circle at center, #0f172a 0%, #000 100%);
        }
        h1, h2, h3, .btn-neon, .stat-label { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        
        #game-container {
            position: relative; width: 1280px; height: 720px;
            box-shadow: 0 0 120px rgba(0,0,0,0.9), 0 0 20px rgba(6, 182, 212, 0.1);
            background: #000; border-radius: 12px; border: 1px solid #1e293b; overflow: hidden;
        }
        canvas { display: block; outline: none; } 
        
        .ui-screen {
            position: absolute; inset: 0; background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; transition: all 0.3s ease;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; display: none !important; }
        
        .glass-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(255,255,255,0.08); border-top: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); backdrop-filter: blur(20px);
            border-radius: 16px;
        }

        .btn-neon {
            background: linear-gradient(180deg, var(--neon-blue), #1e40af);
            border: none; padding: 14px 40px; color: white; font-weight: 900;
            text-transform: uppercase; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 0px rgba(0,0,0,0.5);
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .btn-neon:hover { transform: translateY(-3px) scale(1.05); filter: brightness(1.3); box-shadow: 0 0 30px var(--neon-blue); }
        
        .btn-story {
            background: linear-gradient(180deg, #334155, #0f172a);
            border: none; padding: 14px 40px; color: #94a3b8; font-weight: 900;
            text-transform: uppercase; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            cursor: not-allowed; transition: all 0.2s; text-shadow: 0 1px 0px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1); position: relative;
        }
        .btn-story::after { content: 'üîí'; font-size: 12px; position: absolute; top: 5px; right: 5px; opacity: 0.5; }

        .btn-icon {
            width: 44px; height: 44px; border: 1px solid #334155; background: #1e293b;
            color: #94a3b8; font-size: 20px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn-icon:hover { border-color: var(--neon-blue); color: white; background: #334155; }
        .tool-selected { border-color: #facc15; color: #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.2); transform: scale(1.1); z-index: 2; }

        .armory-container { display: flex; gap: 40px; width: 90%; max-width: 1100px; height: 500px; }
        .char-column { flex: 1; display: flex; flex-direction: column; gap: 15px; position: relative; }
        
        .char-preview-box {
            flex: 1; background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.3) 70%);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .char-preview-box::before { content: ''; position: absolute; inset: 0; background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImEiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgMTBoNDBWMEgwIiBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4wMykiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNhKSIvPjwvc3ZnPg=='); opacity: 0.5; }
        
        .stat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .stat-name { font-size: 10px; color: #94a3b8; width: 50px; text-align: right; font-weight: bold; }
        .stat-track { flex: 1; height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; }
        .stat-fill { height: 100%; width: 50%; background: #3b82f6; transition: width 0.3s ease; box-shadow: 0 0 10px currentColor; }

        .input-group label { display: block; font-size: 9px; color: #cbd5e1; margin-bottom: 2px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
        select, input[type="color"], input[type="text"] {
            width: 100%; padding: 10px 12px; background: rgba(2, 6, 23, 0.8); border: 1px solid #334155; 
            color: white; border-radius: 6px; outline: none; font-size: 14px; font-family: 'Rajdhani', sans-serif;
            transition: all 0.2s; cursor: pointer; text-transform: uppercase; font-weight: bold;
        }
        select:hover, input[type="text"]:hover { border-color: var(--neon-blue); background: rgba(15, 23, 42, 0.9); }
        input[type="text"]:focus, select:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(6, 182, 212, 0.2); }
        input[type="color"] { height: 40px; padding: 0; border: none; border-radius: 6px; overflow: hidden; }

        .secret-panel { padding: 8px; border: 1px dashed #facc15; border-radius: 6px; background: rgba(250, 204, 21, 0.05); animation: pulse-border 2s infinite; display: none; }
        .secret-panel.unlocked { display: block; }
        @keyframes pulse-border { 0%{border-color:#facc15} 50%{border-color:#ca8a04} 100%{border-color:#facc15} }

        .victory-anim { animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes zoomIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        #toast-msg {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(234, 179, 8, 0.95); color: #000; padding: 15px 40px;
            font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.5rem;
            border-radius: 4px; border: 2px solid #fff; box-shadow: 0 0 50px rgba(234, 179, 8, 0.8);
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100;
            clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%, 0 20%);
        }
        #toast-msg.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
    </style>
</head>
<body onclick="AudioEngine.start()">

    <div id="game-container">
        <canvas id="gameCanvas" width="1280" height="720"></canvas>
        <div id="toast-msg">¬°PR√ìXIMAMENTE!</div>

        <div id="menu-screen" class="ui-screen">
            <h1 class="text-9xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 via-blue-600 to-purple-600 drop-shadow-[0_0_60px_rgba(6,182,212,0.6)] tracking-tighter italic">PIXEL ULTRA</h1>
            <p class="mb-12 text-slate-300 tracking-[1.5em] font-bold text-xs uppercase border-t border-b border-slate-700 py-2">BETA </p>
            <div class="flex flex-col gap-6 items-center">
                <div class="flex gap-8">
                    <button onclick="SFX.ui(); Game.goToSelect()" class="btn-neon text-2xl px-16 py-6 tracking-widest">VS. DUELO</button>
                    <button onclick="SFX.ui(); Game.showStoryMsg()" class="btn-story text-2xl px-16 py-6 tracking-widest">MODO HISTORIA</button>
                </div>
                <div class="flex gap-6 mt-4">
                    <button onclick="SFX.ui(); Game.goToCustom()" class="btn-neon bg-gradient-to-b from-purple-500 to-purple-900 px-10 py-3 text-sm border-purple-400" style="--neon-blue: #d946ef">ARMER√çA</button>
                    <button onclick="SFX.ui(); Game.showStoryMsg()" class="btn-story px-10 py-3 text-sm">EDITOR DE MAPAS</button>
                </div>
            </div>
        </div>

        <div id="select-screen" class="ui-screen hidden" style="background: rgba(2,6,23,0.3); flex-direction: row; justify-content: flex-start;">
            <div class="glass-panel h-full w-96 p-8 border-r border-white/5 z-10 flex flex-col">
                <h2 class="text-4xl font-black mb-8 text-white tracking-widest border-b-2 border-cyan-500/50 pb-4">ARENAS</h2>
                <div class="space-y-4 flex-1 overflow-y-auto custom-scroll pr-3">
                    <button onmouseenter="Game.previewMap('neon'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('neon')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-cyan-900/60 border border-slate-700 hover:border-cyan-400 rounded-lg transition-all group relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="font-bold text-xl text-cyan-300 group-hover:text-white relative z-10">NEON CITY</div>
                        <div class="text-xs text-slate-400 relative z-10">Cyberpunk. Equilibrado.</div>
                    </button>
                    <button onmouseenter="Game.previewMap('forest'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('forest')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-green-900/60 border border-slate-700 hover:border-green-400 rounded-lg transition-all group relative overflow-hidden">
                        <div class="font-bold text-xl text-green-300 group-hover:text-white relative z-10">CYBER FOREST</div>
                        <div class="text-xs text-slate-400 relative z-10">Naturaleza digital.</div>
                    </button>
                    <button onmouseenter="Game.previewMap('magma'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('magma')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-red-900/60 border border-slate-700 hover:border-red-500 rounded-lg transition-all group relative overflow-hidden">
                        <div class="font-bold text-xl text-red-400 group-hover:text-white relative z-10">MAGMA CORE</div>
                        <div class="text-xs text-slate-400 relative z-10">Volc√°n activo. Lava.</div>
                    </button>
                    <button onmouseenter="Game.previewMap('glacier'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('glacier')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-indigo-900/60 border border-slate-700 hover:border-indigo-400 rounded-lg transition-all group relative overflow-hidden">
                        <div class="font-bold text-xl text-indigo-300 group-hover:text-white relative z-10">GLACIER</div>
                        <div class="text-xs text-slate-400 relative z-10">Hielo. Plataformas m√≥viles.</div>
                    </button>
                    <button onmouseenter="Game.previewMap('void'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('void')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-purple-900/60 border border-slate-700 hover:border-purple-400 rounded-lg transition-all group relative overflow-hidden">
                        <div class="font-bold text-xl text-purple-300 group-hover:text-white relative z-10">THE VOID</div>
                        <div class="text-xs text-slate-400 relative z-10">Experto. M√≠nimo suelo.</div>
                    </button>
                </div>
                
                <div class="mt-6 pt-6 border-t border-white/10 text-center relative overflow-hidden bg-black/40 rounded-lg p-4">
                    <p class="text-xs text-yellow-500 font-black tracking-[0.2em] mb-1 animate-pulse">‚ö° PR√ìXIMAMENTE ‚ö°</p>
                    <p class="text-[10px] text-slate-400 uppercase font-bold">M√°s Arenas & Modos de juego</p>
                </div>

                <button onclick="SFX.ui(); Game.goToMenu()" class="mt-4 py-4 text-slate-500 hover:text-white tracking-widest font-bold transition-colors w-full border-t border-white/5 uppercase">‚Üê Volver al Men√∫</button>
            </div>
            <div class="flex-1 h-full pointer-events-none flex items-center justify-center relative">
                <h2 id="preview-title" class="text-9xl font-black text-white/5 uppercase tracking-widest drop-shadow-xl select-none absolute">PREVIEW</h2>
            </div>
        </div>

        <div id="custom-screen" class="ui-screen hidden">
            <div class="flex justify-between items-center w-[90%] max-w-[1100px] mb-6 border-b-2 border-white/10 pb-4">
                <h2 class="text-5xl font-black text-white tracking-wider">ARMER√çA</h2>
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase tracking-widest">Estado del Sistema</div>
                    <div class="text-emerald-400 font-bold">ONLINE</div>
                </div>
            </div>

            <div class="armory-container">
                <div class="char-column glass-panel p-6 border-t-4 border-t-cyan-500">
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="text-2xl font-black text-cyan-400 italic">JUGADOR 01</h3>
                        <input type="text" id="p1-n" value="CYBER 01" maxlength="12" class="w-32 text-right !bg-transparent !border-0 !p-0 focus:!ring-0 text-cyan-200">
                    </div>
                    
                    <div class="char-preview-box group cursor-pointer" onclick="Game.unlockSecret(1, event)">
                        <canvas id="p1-preview" width="200" height="200" class="relative z-10 transition-transform group-hover:scale-110 duration-500"></canvas>
                        <div class="absolute bottom-2 text-[9px] text-cyan-500/50 font-mono">MODEL: MK-IV // CLICK HEAD -> ???</div>
                    </div>

                    <div id="p1-stats" class="bg-black/40 p-3 rounded-lg mb-2">
                        <div class="stat-row"><span class="stat-name">ATK</span><div class="stat-track"><div id="p1-stat-atk" class="stat-fill" style="width: 50%; background: #f87171;"></div></div></div>
                        <div class="stat-row"><span class="stat-name">DEF</span><div class="stat-track"><div id="p1-stat-def" class="stat-fill" style="width: 50%; background: #60a5fa;"></div></div></div>
                        <div class="stat-row"><span class="stat-name">SPD</span><div class="stat-track"><div id="p1-stat-spd" class="stat-fill" style="width: 50%; background: #fbbf24;"></div></div></div>
                    </div>

                    <div id="p1-secrets" class="secret-panel mb-2"><div class="text-[10px] font-bold text-yellow-400 text-center mb-1">¬°PROTOCOLO RONIN ACTIVO!</div><label class="checkbox-label justify-center"><input type="checkbox" id="p1-ronin" onchange="Game.updatePreviews()"> Armadura Ronin</label></div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group"><label>Color</label><input type="color" id="p1-c" value="#06b6d4" oninput="Game.updatePreviews()"></div>
                        <div class="input-group"><label>Casco</label><select id="p1-h" onchange="Game.updatePreviews()"><option value="none">---</option><option value="tactical">Tactical</option><option value="oni">Oni</option><option value="viking">Viking</option><option value="samurai">Samurai</option><option value="skull">Skull</option><option value="cyclops">Cyclops</option><option value="hood">Hood</option><option value="pilot">Pilot</option><option value="demon">Demon</option></select></div>
                        <div class="input-group"><label>Armadura</label><select id="p1-a" onchange="Game.updatePreviews()"><option value="none">Standard</option><option value="heavy">Heavy</option><option value="stealth">Stealth</option><option value="knight">Knight</option><option value="nano">Nano</option><option value="juggernaut">Juggernaut</option><option value="cyberninja">Cyber-Ninja</option></select></div>
                        <div class="input-group"><label>Dorsal</label><select id="p1-b" onchange="Game.updatePreviews()"><option value="none">---</option><option value="cape">Cape</option><option value="wings">Wings</option><option value="jetpack">Jetpack</option><option value="battery">Battery</option><option value="spider">Spider Legs</option><option value="halo">Halo</option></select></div>
                        <div class="input-group col-span-2"><label>Arma</label><select id="p1-w" onchange="Game.updatePreviews()"><option value="sword">Energy Sword</option><option value="katana">Nanocarbon Katana</option><option value="scythe">Void Scythe</option><option value="hammer">Gravity Hammer</option><option value="spear">Laser Spear</option><option value="daggers">Dual Daggers</option><option value="laseraxe">Laser Axe</option><option value="whip">Plasma Whip</option><option value="fists">Power Fists</option></select></div>
                    </div>
                </div>

                <div class="char-column glass-panel p-6 border-t-4 border-t-red-500">
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="text-2xl font-black text-red-400 italic">JUGADOR 02</h3>
                        <input type="text" id="p2-n" value="SLAYER 02" maxlength="12" class="w-32 text-right !bg-transparent !border-0 !p-0 focus:!ring-0 text-red-200">
                    </div>
                    
                    <div class="char-preview-box group cursor-pointer" onclick="Game.unlockSecret(2, event)">
                        <canvas id="p2-preview" width="200" height="200" class="relative z-10 transition-transform group-hover:scale-110 duration-500"></canvas>
                        <div class="absolute bottom-2 text-[9px] text-red-500/50 font-mono">MODEL: MK-IV // CLICK HEAD -> ???</div>
                    </div>

                    <div id="p2-stats" class="bg-black/40 p-3 rounded-lg mb-2">
                        <div class="stat-row"><span class="stat-name">ATK</span><div class="stat-track"><div id="p2-stat-atk" class="stat-fill" style="width: 50%; background: #f87171;"></div></div></div>
                        <div class="stat-row"><span class="stat-name">DEF</span><div class="stat-track"><div id="p2-stat-def" class="stat-fill" style="width: 50%; background: #60a5fa;"></div></div></div>
                        <div class="stat-row"><span class="stat-name">SPD</span><div class="stat-track"><div id="p2-stat-spd" class="stat-fill" style="width: 50%; background: #fbbf24;"></div></div></div>
                    </div>

                    <div id="p2-secrets" class="secret-panel mb-2"><div class="text-[10px] font-bold text-yellow-400 text-center mb-1">¬°PROTOCOLO RONIN ACTIVO!</div><label class="checkbox-label justify-center"><input type="checkbox" id="p2-ronin" onchange="Game.updatePreviews()"> Armadura Ronin</label></div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group"><label>Color</label><input type="color" id="p2-c" value="#ef4444" oninput="Game.updatePreviews()"></div>
                        <div class="input-group"><label>Casco</label><select id="p2-h" onchange="Game.updatePreviews()"><option value="none">---</option><option value="tactical">Tactical</option><option value="oni">Oni</option><option value="viking">Viking</option><option value="samurai">Samurai</option><option value="skull">Skull</option><option value="cyclops">Cyclops</option><option value="hood">Hood</option><option value="pilot">Pilot</option><option value="demon">Demon</option></select></div>
                        <div class="input-group"><label>Armadura</label><select id="p2-a" onchange="Game.updatePreviews()"><option value="none">Standard</option><option value="heavy">Heavy</option><option value="stealth">Stealth</option><option value="knight">Knight</option><option value="nano">Nano</option><option value="juggernaut">Juggernaut</option><option value="cyberninja">Cyber-Ninja</option></select></div>
                        <div class="input-group"><label>Dorsal</label><select id="p2-b" onchange="Game.updatePreviews()"><option value="none">---</option><option value="cape">Cape</option><option value="wings">Wings</option><option value="jetpack">Jetpack</option><option value="battery">Battery</option><option value="spider">Spider Legs</option><option value="halo">Halo</option></select></div>
                        <div class="input-group col-span-2"><label>Arma</label><select id="p2-w" onchange="Game.updatePreviews()"><option value="sword">Energy Sword</option><option value="katana">Nanocarbon Katana</option><option value="scythe">Void Scythe</option><option value="hammer">Gravity Hammer</option><option value="spear">Laser Spear</option><option value="daggers">Dual Daggers</option><option value="laseraxe">Laser Axe</option><option value="whip">Plasma Whip</option><option value="fists">Power Fists</option></select></div>
                    </div>
                </div>
            </div>

            <div class="flex gap-6 mt-8 justify-center">
                <button onclick="SFX.ui(); Game.saveAndExit()" class="btn-neon text-lg px-12">CONFIRMAR EQUIPO</button>
                <button onclick="SFX.ui(); Game.goToMenu()" class="px-8 py-4 text-slate-400 hover:text-white font-bold transition-colors uppercase tracking-widest">Descartar</button>
            </div>
        </div>

        <div id="editor-hud" class="absolute bottom-0 w-full glass-panel p-3 border-t border-white/10 flex items-center gap-3 hidden z-30">
            <div class="flex items-center gap-2 bg-slate-900/50 p-2 rounded-lg border border-slate-700">
                <button onclick="Editor.setTool(1); SFX.ui()" id="tool-1" class="btn-icon tool-selected" title="Bloque S√≥lido">‚¨ú</button>
                <button onclick="Editor.setTool(4); SFX.ui()" id="tool-4" class="btn-icon" title="Plataforma">‚ò∞</button>
                <button onclick="Editor.setTool(3); SFX.ui()" id="tool-3" class="btn-icon text-red-500" title="Pincho (Rotar)">‚ñ≤</button>
                <button onclick="Editor.setTool(5); SFX.ui()" id="tool-5" class="btn-icon text-orange-500" title="Lava">‚âà</button>
            </div>
            <div class="w-px h-10 bg-white/20"></div>
            <button onclick="Editor.setTool(0); SFX.ui()" id="tool-0" class="btn-icon text-slate-500 border-dashed hover:text-red-400 hover:border-red-400" title="Borrador">‚úï</button>
            <div class="flex-1"></div>
            <button onclick="SFX.ui(); Game.testLevel()" id="btn-test" class="btn-neon py-2 px-6 text-sm bg-gradient-to-r from-yellow-500 to-orange-500" style="--neon-blue: #f59e0b">PROBAR</button>
            <button onclick="SFX.ui(); Editor.clear()" class="px-4 py-2 text-red-400 hover:text-red-300 font-bold rounded-md ml-4">LIMPIAR</button>
            <button onclick="SFX.ui(); Game.goToMenu()" class="px-4 py-2 text-slate-400 hover:text-white font-bold">SALIR</button>
        </div>

        <div id="game-hud" class="absolute top-0 w-full p-8 flex justify-between hidden pointer-events-none z-30">
            <div class="w-1/3">
                <div class="flex justify-between text-cyan-400 font-black text-lg mb-2 tracking-wider"><span id="p1-name-hud" class="drop-shadow-[0_0_5px_rgba(6,182,212,0.8)]">JUGADOR 1</span><span id="hp-txt-1">100%</span></div>
                <div class="h-6 bg-slate-900/80 rounded-sm border-2 border-cyan-500/50 overflow-hidden relative shadow-[0_0_20px_rgba(6,182,212,0.3)]"><div id="hp-bar-1" class="h-full bg-gradient-to-r from-cyan-400 to-blue-600 w-full transition-all duration-200"></div></div>
            </div>
            <button onclick="SFX.ui(); Game.goToMenu()" class="pointer-events-auto px-6 py-2 bg-black/40 text-white/40 hover:bg-red-900/80 hover:text-white rounded border border-white/10 text-xs font-bold transition-all backdrop-blur-sm">ABANDONAR</button>
            <div class="w-1/3">
                <div class="flex justify-between text-red-400 font-black text-lg mb-2 tracking-wider"><span id="p2-name-hud" class="drop-shadow-[0_0_5px_rgba(239,68,68,0.8)]">JUGADOR 2</span><span id="hp-txt-2">100%</span></div>
                <div class="h-6 bg-slate-900/80 rounded-sm border-2 border-red-500/50 overflow-hidden relative shadow-[0_0_20px_rgba(239,68,68,0.3)]"><div id="hp-bar-2" class="h-full bg-gradient-to-l from-red-500 to-orange-600 w-full transition-all duration-200 float-right"></div></div>
            </div>
        </div>

        <div id="victory-screen" class="ui-screen hidden z-50" style="background: rgba(0,0,0,0.9);">
            <div class="victory-anim flex flex-col items-center">
                <h1 class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-4 drop-shadow-[0_0_30px_rgba(250,204,21,0.8)] uppercase italic">¬°VICTORIA!</h1>
                <h2 id="winner-name" class="text-9xl font-black text-white mb-10 drop-shadow-xl uppercase tracking-tighter">NOMBRE</h2>
                <div class="flex gap-6">
                    <button onclick="SFX.ui(); Game.restartGame()" class="btn-neon text-lg">RE-MATCH</button>
                    <button onclick="SFX.ui(); Game.goToMenu()" class="px-10 py-4 bg-slate-800 text-white font-bold rounded border border-slate-600 hover:bg-slate-700 transition-colors uppercase tracking-widest">Men√∫ Principal</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MOTOR DE AUDIO (SOLO SFX)
        const AudioEngine={ctx:null,isEnabled:false,masterGain:null,
            start:()=>{
                if(!AudioEngine.ctx){
                    AudioEngine.ctx=new(window.AudioContext||window.webkitAudioContext)();
                    AudioEngine.isEnabled=true;
                    AudioEngine.masterGain=AudioEngine.ctx.createGain();
                    AudioEngine.masterGain.gain.value=0.4;
                    AudioEngine.masterGain.connect(AudioEngine.ctx.destination);
                }
                if(AudioEngine.ctx.state==='suspended')AudioEngine.ctx.resume();
            },
            playTone:(freq,type,dur,vol=0.1)=>{
                if(!AudioEngine.isEnabled)return;
                const o=AudioEngine.ctx.createOscillator(),g=AudioEngine.ctx.createGain();
                o.type=type;o.frequency.setValueAtTime(freq,AudioEngine.ctx.currentTime);
                g.gain.setValueAtTime(vol,AudioEngine.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,AudioEngine.ctx.currentTime+dur);
                o.connect(g);g.connect(AudioEngine.masterGain);o.start();o.stop(AudioEngine.ctx.currentTime+dur);
            },
            // M√öSICA ELIMINADA
            startMusic:()=>{}, 
            stopMusic:()=>{},
            sfx:{
                jump:()=>AudioEngine.playTone(150,'sine',0.2,0.1),
                hit:()=>AudioEngine.playTone(80,'sawtooth',0.1,0.2),
                slash:()=>AudioEngine.playTone(400,'triangle',0.1,0.05),
                ui:()=>AudioEngine.playTone(800,'sine',0.05,0.05),
                unlock:()=>AudioEngine.playTone(1000,'square',0.5,0.1),
                win:()=>{setTimeout(()=>AudioEngine.playTone(300,'square',0.5,0.1),0);setTimeout(()=>AudioEngine.playTone(400,'square',0.5,0.1),200);setTimeout(()=>AudioEngine.playTone(500,'square',1.0,0.1),400);}
            }
        };
        const SFX={ui:AudioEngine.sfx.ui,hover:()=>{},win:AudioEngine.sfx.win};
        const canvas=document.getElementById('gameCanvas');const ctx=canvas.getContext('2d');const TILE=40,COLS=32,ROWS=18,GRAVITY=0.6,FRICTION=0.85,JUMP_FORCE=-13.5,MOVE_SPEED=0.35,MAX_SPEED=2.8; 
        let state='MENU',grid=[],entities=[],movingPlats=[],particles=[],keys={},mouse={x:0,y:0,down:false},frame=0,currentMap='neon';
        let p1Config={name:'CYBER 01',color:'#06b6d4',helmet:'none',armor:'none',back:'none',weapon:'sword',rgb:false,ronin:false};
        let p2Config={name:'SLAYER 02',color:'#dc2626',helmet:'none',armor:'none',back:'none',weapon:'katana',rgb:false,ronin:false};
        let bgElements = [];

        class Player{
            constructor(id,x,y,cfg){this.id=id;this.x=x;this.y=y;this.config=cfg;this.w=22;this.h=42;this.vx=0;this.vy=0;this.hp=100;this.grounded=false;this.facingRight=id===1;this.stun=0;this.atkCd=0;this.animFrame=0;
            this.ctrl=id===1?{l:'a',r:'d',u:'w',atk:' '}:{l:'arrowleft',r:'arrowright',u:'arrowup',atk:'enter'};}
            update(){
                if(this.hp<=0)return; let inLava=Physics.checkLava(this);
                if(this.stun<=0){
                    if(keys[this.ctrl.l]){this.vx-=MOVE_SPEED;this.facingRight=false;this.animFrame++;}
                    if(keys[this.ctrl.r]){this.vx+=MOVE_SPEED;this.facingRight=true;this.animFrame++;}
                    if(keys[this.ctrl.u]){if(this.grounded){this.vy=JUMP_FORCE;this.grounded=false;AudioEngine.sfx.jump();}else if(inLava){this.vy=-7;AudioEngine.sfx.jump();}}
                    if(keys[this.ctrl.atk]&&this.atkCd<=0)this.attack();
                }else this.stun--;
                if(this.atkCd>0)this.atkCd--;
                if(inLava){this.vx*=0.6;this.vy*=0.6;if(frame%30===0)this.hit(2);}else{this.vy+=GRAVITY;this.vx*=FRICTION;}
                this.vx=Math.max(Math.min(this.vx,MAX_SPEED),-MAX_SPEED); this.x+=this.vx; Physics.collideX(this); this.y+=this.vy; Physics.collideY(this); Physics.checkSpikes(this); if(this.y>750)this.hit(100);
            }
            attack(){this.atkCd=40;AudioEngine.sfx.slash();let range=65;let hx=this.facingRight?this.x+this.w:this.x-range;particles.push({x:hx+(this.facingRight?0:range),y:this.y+20,color:this.config.color,life:10,size:2,isSlash:true});let enemy=entities.find(e=>e.id!==this.id);if(enemy&&enemy.hp>0&&hx<enemy.x+enemy.w&&hx+range>enemy.x&&Math.abs(this.y-enemy.y)<45){enemy.hit(12);enemy.vx=this.facingRight?7:-7;enemy.vy=-6;}}
            hit(dmg){AudioEngine.sfx.hit();this.hp-=dmg;this.stun=15;for(let i=0;i<8;i++)particles.push({x:this.x+11,y:this.y+20,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,color:this.config.color,life:25,size:3});Game.updateUI();if(this.hp<=0)Game.endGame(this.id===1?2:1);}
            draw(ctx){if(this.hp<=0)return;drawCharacterDetailed(ctx,this.x,this.y,this.facingRight,this.config.color,this.config,this.animFrame,this.atkCd);}
        }

        class MovingPlat { constructor(x,y,dx,dy,speed){this.start={x:x*TILE,y:y*TILE};this.x=this.start.x;this.y=this.start.y;this.w=TILE*3;this.h=15;this.dx=dx*TILE;this.dy=dy*TILE;this.speed=speed;} update(){let s=Math.sin(frame*this.speed);this.x=this.start.x+this.dx*s;this.y=this.start.y+this.dy*s;} draw(ctx){ctx.fillStyle='#64748b';ctx.fillRect(this.x,this.y,this.w,this.h);ctx.fillStyle='#94a3b8';ctx.fillRect(this.x,this.y,this.w,3);ctx.fillStyle='#334155';ctx.fillRect(this.x,this.y+12,this.w,3);}}

        function drawCharacterDetailed(ctx,x,y,facingRight,color,config,animFrame=0,atkCd=0){
            ctx.save(); ctx.translate(x+11,y+21); if(!facingRight)ctx.scale(-1,1);
            let breath=Math.sin(frame*0.05)*1, walk=Math.sin(animFrame*0.3)*4, armRot=atkCd>25?-50+(40-atkCd)*2:(Math.sin(frame*0.05)*5);
            let renderColor = config.rgb ? `hsl(${frame*2},100%,60%)` : color;
            
            if(config.back==='cape'){let flow=Math.sin(frame*0.2)*3;ctx.fillStyle=renderColor;ctx.globalAlpha=0.6;ctx.beginPath();ctx.moveTo(-6,-12+breath);ctx.lineTo(-16+flow,25+walk+flow);ctx.lineTo(-2+flow,25-walk+flow);ctx.lineTo(6,-12+breath);ctx.fill();ctx.globalAlpha=1;}
            else if(config.back==='wings'){ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=15;ctx.globalAlpha=0.6;let wingFlap=Math.sin(frame*0.1)*5;ctx.beginPath();ctx.moveTo(-4,-10+breath);ctx.quadraticCurveTo(-25+wingFlap,-40,-35+wingFlap,10);ctx.quadraticCurveTo(-15,-10,-4,0+breath);ctx.fill();ctx.shadowBlur=0;ctx.globalAlpha=1;}
            else if(config.back==='jetpack'){ctx.fillStyle='#475569';ctx.fillRect(-12,-12+breath,8,20);ctx.fillStyle='#334155';ctx.fillRect(-10,-8+breath,4,12);ctx.fillStyle=renderColor;ctx.fillRect(-11,-2+breath,2,2);}
            else if(config.back==='battery'){ctx.fillStyle='#334155';ctx.fillRect(-10,-12+breath,6,20);ctx.fillStyle=renderColor;ctx.fillRect(-9,-10+breath,4,16);ctx.fillStyle='white';ctx.globalAlpha=0.5;ctx.fillRect(-8,-10+breath,2,16);ctx.globalAlpha=1;}
            else if(config.back==='spider'){ctx.strokeStyle='#334155';ctx.lineWidth=2; for(let i=0;i<4;i++){let dy=i*5; ctx.beginPath();ctx.moveTo(-5,-5+dy+breath);ctx.lineTo(-20, -10+dy+breath+Math.sin(frame*0.1+i)*5);ctx.stroke();}}
            else if(config.back==='halo'){ctx.strokeStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(0,-35+breath*2,10,3,0,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;}

            ctx.fillStyle='#0f172a';ctx.beginPath();ctx.moveTo(-5,-2);ctx.lineTo(-7,15);ctx.lineTo(-3,15);ctx.lineTo(-1,-2);ctx.fill();ctx.beginPath();ctx.moveTo(1,-2);ctx.lineTo(-1+walk,15);ctx.lineTo(3+walk,15);ctx.lineTo(5,-2);ctx.fill();
            ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-6+walk,8,4,2);ctx.fillRect(-1-walk*0.5,8,4,2);ctx.shadowBlur=0;
            ctx.fillStyle='#1e293b';ctx.beginPath();ctx.moveTo(-8,-12+breath);ctx.lineTo(8,-12+breath);ctx.lineTo(6,2);ctx.lineTo(-6,2);ctx.fill();
            
            if(config.ronin) {ctx.fillStyle='#b91c1c'; ctx.fillRect(-9,-12+breath,18,14); ctx.fillStyle=renderColor; ctx.beginPath(); ctx.moveTo(-6,-12+breath); ctx.lineTo(0,-6+breath); ctx.lineTo(6,-12+breath); ctx.fill();} 
            else if(config.armor==='heavy'){ctx.fillStyle='#334155'; ctx.fillRect(-9,-10+breath,18,10); ctx.fillStyle=renderColor; ctx.fillRect(-4,-6+breath,8,4);} 
            else if(config.armor==='stealth'){ctx.strokeStyle=renderColor; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(-6,-8+breath); ctx.lineTo(0,2+breath); ctx.lineTo(6,-8+breath); ctx.stroke();} 
            else if(config.armor==='knight'){ctx.fillStyle='#475569'; ctx.fillRect(-10,-11+breath,20,12); ctx.fillStyle=renderColor;ctx.beginPath(); ctx.moveTo(-12,-12+breath); ctx.lineTo(-8,-14+breath); ctx.lineTo(-8,-8+breath); ctx.fill();ctx.beginPath(); ctx.moveTo(12,-12+breath); ctx.lineTo(8,-14+breath); ctx.lineTo(8,-8+breath); ctx.fill();ctx.fillRect(-5,-9+breath,10,6);} 
            else if(config.armor==='nano'){ctx.fillStyle='#1e293b'; ctx.fillRect(-7,-10+breath,14,10);ctx.strokeStyle=renderColor; ctx.globalAlpha=0.5; ctx.lineWidth=1; ctx.beginPath();ctx.moveTo(-4,-8+breath); ctx.lineTo(0,-10+breath); ctx.lineTo(4,-8+breath);ctx.moveTo(-4,-4+breath); ctx.lineTo(0,-6+breath); ctx.lineTo(4,-4+breath);ctx.moveTo(0,-2+breath); ctx.lineTo(0,2+breath); ctx.stroke(); ctx.globalAlpha=1;} 
            else if(config.armor==='juggernaut'){ctx.fillStyle='#111827'; ctx.fillRect(-11,-12+breath,22,16); ctx.fillStyle=renderColor; ctx.fillRect(-5,-8+breath,10,8);}
            else if(config.armor==='cyberninja'){ctx.fillStyle='#000'; ctx.beginPath();ctx.moveTo(-8,-12+breath);ctx.lineTo(0,0+breath);ctx.lineTo(8,-12+breath);ctx.fill(); ctx.strokeStyle=renderColor; ctx.stroke();}
            else {ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-5,-8+breath,10,6);ctx.shadowBlur=0;}
            
            ctx.fillStyle='#f1f5f9';ctx.beginPath();ctx.arc(0,-17+breath,6,0,Math.PI*2);ctx.fill();
            if(config.ronin) { ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(0,-17+breath,7,0,Math.PI*2); ctx.fill(); ctx.fillStyle=renderColor; ctx.beginPath(); ctx.moveTo(-8,-22+breath); ctx.quadraticCurveTo(0,-35+breath,8,-22+breath); ctx.fill(); }
            else if(config.helmet==='tactical'){ctx.fillStyle='#0f172a';ctx.beginPath();ctx.moveTo(-7,-19+breath);ctx.lineTo(7,-19+breath);ctx.lineTo(7,-24+breath);ctx.lineTo(4,-26+breath);ctx.lineTo(-4,-26+breath);ctx.lineTo(-7,-24+breath);ctx.fill();ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-5,-19+breath,10,3);ctx.shadowBlur=0;}
            else if(config.helmet==='oni'){ctx.fillStyle='#991b1b';ctx.beginPath();ctx.arc(0,-17+breath,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.moveTo(-4,-22+breath);ctx.lineTo(-6,-28+breath);ctx.lineTo(-2,-24+breath);ctx.moveTo(4,-22+breath);ctx.lineTo(6,-28+breath);ctx.lineTo(2,-24+breath);ctx.fill();}
            else if(config.helmet==='viking'){ctx.fillStyle='#334155';ctx.fillRect(-7,-22+breath,14,6);ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=8;ctx.beginPath();ctx.moveTo(-7,-20+breath);ctx.lineTo(-12,-30+breath);ctx.lineTo(-9,-22+breath);ctx.moveTo(7,-20+breath);ctx.lineTo(12,-30+breath);ctx.lineTo(9,-22+breath);ctx.fill();ctx.shadowBlur=0;}
            else if(config.helmet==='samurai'){ctx.fillStyle='#1e293b';ctx.beginPath();ctx.arc(0,-18+breath,8,Math.PI,0);ctx.fill();ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.arc(0,-24+breath,6,0,Math.PI,true);ctx.fill();}
            else if(config.helmet==='skull'){ctx.fillStyle='#f1f5f9';ctx.beginPath();ctx.arc(0,-18+breath,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-4,-19+breath,3,3);ctx.fillRect(1,-19+breath,3,3);ctx.fillRect(-2,-14+breath,4,2);}
            else if(config.helmet==='cyclops'){ctx.fillStyle='#334155';ctx.beginPath();ctx.arc(0,-18+breath,8,0,Math.PI*2);ctx.fill();ctx.fillStyle=renderColor;ctx.shadowBlur=5;ctx.shadowColor=renderColor;ctx.beginPath();ctx.arc(0,-18+breath,3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
            else if(config.helmet==='hood'){ctx.fillStyle='#333'; ctx.beginPath();ctx.arc(0,-18+breath,9,Math.PI,0);ctx.lineTo(9,-10+breath);ctx.lineTo(-9,-10+breath);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-5,-18+breath,10,4);}
            else if(config.helmet==='pilot'){ctx.fillStyle='#334155';ctx.beginPath();ctx.arc(0,-18+breath,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fbbf24';ctx.fillRect(-6,-20+breath,12,6);}
            else if(config.helmet==='demon'){ctx.fillStyle='#7f1d1d';ctx.beginPath();ctx.arc(0,-17+breath,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.moveTo(-5,-22+breath);ctx.lineTo(-10,-35+breath);ctx.lineTo(0,-25+breath);ctx.moveTo(5,-22+breath);ctx.lineTo(10,-35+breath);ctx.lineTo(0,-25+breath);ctx.fill();}

            ctx.save();ctx.translate(0,-9+breath);ctx.rotate(armRot*Math.PI/180);ctx.fillStyle=renderColor;ctx.beginPath();ctx.arc(0,0,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#1e293b';ctx.fillRect(-2,0,4,10);
            if(config.weapon==='scythe'){ctx.fillStyle='#0f172a';ctx.fillRect(-1,6,2,30);ctx.fillStyle='#94a3b8';ctx.beginPath();ctx.moveTo(0,6);ctx.quadraticCurveTo(25,0,30,15);ctx.lineTo(25,18);ctx.quadraticCurveTo(20,8,0,10);ctx.fill();ctx.strokeStyle=renderColor;ctx.lineWidth=2;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.beginPath();ctx.moveTo(0,6);ctx.quadraticCurveTo(25,0,30,15);ctx.stroke();ctx.shadowBlur=0;}
            else if(config.weapon==='katana'){ctx.fillStyle='#000';ctx.fillRect(-1,8,2,8);ctx.fillStyle='#fff';ctx.beginPath();ctx.moveTo(0,16);ctx.quadraticCurveTo(3,30,1,45);ctx.lineTo(-1,45);ctx.quadraticCurveTo(1,30,-1,16);ctx.fill();ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-3,14,6,2);ctx.shadowBlur=0;}
            else if(config.weapon==='hammer'){ctx.fillStyle='#5d4037';ctx.fillRect(-2,6,4,24);ctx.fillStyle='#334155';ctx.fillRect(-8,4,16,10);ctx.strokeStyle=renderColor;ctx.lineWidth=2;ctx.strokeRect(-8,4,16,10);}
            else if(config.weapon==='spear'){ctx.fillStyle='#5d4037';ctx.fillRect(-1,6,2,36);ctx.fillStyle='#94a3b8';ctx.beginPath();ctx.moveTo(0,42);ctx.lineTo(-3,36);ctx.lineTo(3,36);ctx.fill();ctx.fillStyle=renderColor;ctx.fillRect(-1,36,2,4);}
            else if(config.weapon==='daggers'){ctx.fillStyle='#334155';ctx.fillRect(-4,8,2,6);ctx.fillStyle=renderColor;ctx.fillRect(-4,14,2,10);ctx.fillStyle='#334155';ctx.fillRect(2,8,2,6);ctx.fillStyle=renderColor;ctx.fillRect(2,14,2,10);}
            else if(config.weapon==='laseraxe'){ctx.fillStyle='#333';ctx.fillRect(-2,6,4,20); ctx.fillStyle=renderColor; ctx.shadowColor=renderColor;ctx.shadowBlur=10; ctx.beginPath();ctx.moveTo(-10,10);ctx.lineTo(10,10);ctx.lineTo(15,25);ctx.lineTo(-15,25);ctx.fill(); ctx.shadowBlur=0;}
            else if(config.weapon==='whip'){ctx.strokeStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,6);ctx.quadraticCurveTo(10,20,-5,30);ctx.stroke(); ctx.shadowBlur=0;}
            else if(config.weapon==='fists'){ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.fillRect(-4,10,8,8);ctx.shadowBlur=0;}
            else{ctx.fillStyle='#334155';ctx.fillRect(-3,12,6,2);ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.fillRect(-1.5,14,3,24);ctx.shadowBlur=0;ctx.globalAlpha=0.7;ctx.fillStyle='white';ctx.fillRect(-0.5,14,1,24);ctx.globalAlpha=1;}
            ctx.restore();ctx.restore();
        }

        const Physics={
            collideX:(e)=>{let l=Math.floor(e.x/TILE),r=Math.floor((e.x+e.w-0.01)/TILE),t=Math.floor(e.y/TILE),b=Math.floor((e.y+e.h-0.01)/TILE);if(e.vx>0&&(Physics.solid(r,t)||Physics.solid(r,b))){e.x=r*TILE-e.w-0.01;e.vx=0;}else if(e.vx<0&&(Physics.solid(l,t)||Physics.solid(l,b))){e.x=(l+1)*TILE+0.01;e.vx=0;}},
            collideY:(e)=>{let l=Math.floor(e.x/TILE),r=Math.floor((e.x+e.w-0.01)/TILE),t=Math.floor(e.y/TILE),b=Math.floor((e.y+e.h-0.01)/TILE);if(e.vy>0){if(Physics.solid(l,b)||Physics.solid(r,b)){e.y=b*TILE-e.h-0.01;e.vy=0;e.grounded=true;return;}let fp=e.y-e.vy+e.h;if((Physics.plat(l,b)||Physics.plat(r,b))&&fp<=b*TILE+10){e.y=b*TILE-e.h-0.01;e.vy=0;e.grounded=true;return;}
            for(let mp of movingPlats){if(e.x+e.w>mp.x&&e.x<mp.x+mp.w&&fp<=mp.y+10&&fp>=mp.y-5){e.y=mp.y-e.h;e.vy=0;e.grounded=true;e.x+=(mp.x-(mp.start.x+mp.dx*Math.sin((frame-1)*mp.speed)));return;}}}
            else if(e.vy<0&&(Physics.solid(l,t)||Physics.solid(r,t))){e.y=(t+1)*TILE+0.01;e.vy=0;}e.grounded=false;},
            checkLava:(e)=>{let cx=Math.floor((e.x+e.w/2)/TILE),fy=Math.floor((e.y+e.h)/TILE);return (grid[cx]?grid[cx][fy]:0)===5;},
            checkSpikes:(e)=>{let cx=Math.floor((e.x+e.w/2)/TILE),fy=Math.floor((e.y+e.h)/TILE);if((grid[cx]?grid[cx][fy]:0)>=30){e.hit(15);e.vy=-10;}},
            solid:(x,y)=>x>=0&&x<COLS&&y>=0&&y<ROWS&&(grid[x][y]===1||grid[x][y]===9), plat:(x,y)=>x>=0&&x<COLS&&y>=0&&y<ROWS&&grid[x][y]===4
        };

        const Game={
            init:()=>{
                Editor.initGrid();Game.updatePreviews();
                window.addEventListener('keydown',e=>{let k=e.key.toLowerCase();if(e.code==='Space')k=' ';keys[k]=true;});
                window.addEventListener('keyup',e=>{let k=e.key.toLowerCase();if(e.code==='Space')k=' ';keys[k]=false;});
                canvas.addEventListener('mousedown',e=>{AudioEngine.start();mouse.down=true;Game.trackMouse(e);if(state==='EDITOR')Editor.interact();});
                canvas.addEventListener('mousemove',e=>{Game.trackMouse(e);if(state==='EDITOR'&&mouse.down)Editor.interact();});
                window.addEventListener('mouseup',()=>mouse.down=false);
                Game.loop();
            },
            trackMouse:(e)=>{const r=canvas.getBoundingClientRect();mouse.x=Math.floor((e.clientX-r.left)/(r.width/COLS));mouse.y=Math.floor((e.clientY-r.top)/(r.height/ROWS));},
            loop:()=>{frame++;
                Renderer.drawBackground(currentMap);
                Renderer.drawMap();if(state==='GAME'||state==='TEST'||state==='SELECT'){entities.forEach(e=>{e.update();e.draw(ctx);});Renderer.drawParticles();}if(state==='EDITOR')Renderer.drawEditor();if(state==='SELECT'){ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(0,0,1280,720);}requestAnimationFrame(Game.loop);},
            showScreen:(id)=>{document.querySelectorAll('.ui-screen,#editor-hud,#game-hud,#victory-screen').forEach(e=>e.classList.add('hidden'));if(id)document.getElementById(id).classList.remove('hidden');},
            goToMenu:()=>{Game.showScreen('menu-screen');state='MENU';entities=[];Game.loadMap('neon');AudioEngine.stopMusic();},
            goToCustom:()=>{Game.showScreen('custom-screen');Game.updatePreviews();},
            goToSelect:()=>{Game.showScreen('select-screen');state='SELECT';Game.previewMap('neon');},
            startEditor:()=>{Game.showScreen('editor-hud');state='EDITOR';Editor.clear();}, 
            startGame:()=>{Game.showScreen('game-hud');state='GAME';entities=[new Player(1,100,100,p1Config),new Player(2,1100,100,p2Config)];Game.updateUI();document.getElementById('p1-name-hud').innerText=p1Config.name;document.getElementById('p2-name-hud').innerText=p2Config.name;AudioEngine.startMusic();},
            saveAndExit:()=>{p1Config.name=document.getElementById('p1-n').value;p2Config.name=document.getElementById('p2-n').value;Game.goToMenu();},
            showStoryMsg:()=>{const t=document.getElementById('toast-msg');t.classList.add('show');SFX.ui();setTimeout(()=>t.classList.remove('show'),2000);},
            testLevel:()=>{let btn=document.getElementById('btn-test');if(state==='EDITOR'){state='TEST';entities=[new Player(1,100,100,p1Config),new Player(2,1100,100,p2Config)];btn.innerText="PARAR";btn.style.background='#dc2626';}else{state='EDITOR';entities=[];btn.innerText="PROBAR";btn.style.background='';}},
            updatePreviews:()=>{
                p1Config={name:p1Config.name,color:document.getElementById('p1-c').value,helmet:document.getElementById('p1-h').value,back:document.getElementById('p1-b').value,weapon:document.getElementById('p1-w').value,armor:document.getElementById('p1-a').value,rgb:false,ronin:document.getElementById('p1-ronin').checked};
                p2Config={name:p2Config.name,color:document.getElementById('p2-c').value,helmet:document.getElementById('p2-h').value,back:document.getElementById('p2-b').value,weapon:document.getElementById('p2-w').value,armor:document.getElementById('p2-a').value,rgb:false,ronin:document.getElementById('p2-ronin').checked};
                Game.renderPrev('p1-preview',p1Config,true);Game.renderPrev('p2-preview',p2Config,false);
                const r=()=>30+Math.random()*70;
                document.getElementById('p1-stat-atk').style.width=r()+'%'; document.getElementById('p1-stat-def').style.width=r()+'%'; document.getElementById('p1-stat-spd').style.width=r()+'%';
                document.getElementById('p2-stat-atk').style.width=r()+'%'; document.getElementById('p2-stat-def').style.width=r()+'%'; document.getElementById('p2-stat-spd').style.width=r()+'%';
            },
            renderPrev:(id,cfg,right)=>{let pCtx=document.getElementById(id).getContext('2d');pCtx.clearRect(0,0,200,200);pCtx.save();pCtx.translate(100,100);pCtx.scale(4,4);pCtx.translate(-11,-21);drawCharacterDetailed(pCtx,0,0,right,cfg.color,cfg);pCtx.restore();},
            clickSecret:(id,e)=>{let rect=e.target.getBoundingClientRect(); if((e.clientY-rect.top)<100){AudioEngine.sfx.win(); document.getElementById(id===1?'p1-secrets':'p2-secrets').classList.add('unlocked');}},
            updateUI:()=>{if(entities.length<2)return;document.getElementById('hp-bar-1').style.width=Math.max(0,entities[0].hp)+'%';document.getElementById('hp-bar-2').style.width=Math.max(0,entities[1].hp)+'%';document.getElementById('hp-txt-1').innerText=Math.ceil(Math.max(0,entities[0].hp))+'%';document.getElementById('hp-txt-2').innerText=Math.ceil(Math.max(0,entities[1].hp))+'%';},
            loadMap:(t)=>{
                grid=new Array(COLS).fill(0).map(()=>new Array(ROWS).fill(0));movingPlats=[];currentMap=t;bgElements=[]; 
                if(t==='neon'){for(let i=0;i<15;i++)bgElements.push({x:i*90+Math.random()*40,y:100+Math.random()*200,w:50+Math.random()*40});}
                else if(t==='forest'){for(let i=0;i<20;i++)bgElements.push({x:Math.random()*1280,h:200+Math.random()*200});}
                else if(t==='void'){for(let i=0;i<100;i++)bgElements.push({x:Math.random()*1280,y:Math.random()*720,s:Math.random()*2});}
                else if(t==='glacier'){for(let i=0;i<10;i++)bgElements.push({x:i*130,h:200+Math.random()*300});}
                for(let i=0;i<COLS;i++){grid[i][0]=9;grid[i][ROWS-1]=9;}for(let i=0;i<ROWS;i++){grid[0][i]=9;grid[COLS-1][i]=9;}
                
                if(t==='neon'){for(let x=2;x<30;x++)grid[x][16]=1;grid[8][14]=1;grid[9][13]=4;grid[23][14]=1;grid[22][13]=4;for(let x=10;x<22;x++)grid[x][12]=4;movingPlats.push(new MovingPlat(4,10,3,0,0.02));movingPlats.push(new MovingPlat(25,10,-3,0,0.02));}
                else if(t==='magma'){for(let x=1;x<31;x++)grid[x][16]=(x>10&&x<22)?5:1;grid[8][13]=1;grid[9][13]=4;grid[23][13]=1;grid[22][13]=4;movingPlats.push(new MovingPlat(11,11,0,3,0.02));movingPlats.push(new MovingPlat(18,11,0,-3,0.02));}
                else if(t==='forest'){for(let x=1;x<31;x++)grid[x][16]=1;grid[5][12]=4;grid[6][12]=4;grid[25][12]=4;grid[26][12]=4;grid[15][10]=4;grid[16][10]=4;movingPlats.push(new MovingPlat(10,13,10,0,0.03));}
                else if(t==='glacier'){for(let i=0;i<4;i++){grid[2+i][14]=1; grid[3+i][14]=1;grid[29-i][14]=1; grid[28-i][14]=1;}grid[8][11]=4; grid[23][11]=4; grid[14][9]=4; grid[17][9]=4;for(let x=1;x<31;x++)grid[x][17]=1; movingPlats.push(new MovingPlat(14,12,0,2,0.02));}
                else if(t==='void'){grid[2][14]=1; grid[3][14]=1; grid[28][14]=1; grid[29][14]=1; grid[14][10]=1; grid[15][10]=1; grid[16][10]=1; grid[17][10]=1; grid[8][12]=4; grid[23][12]=4; movingPlats.push(new MovingPlat(5,12,2,0,0.025)); movingPlats.push(new MovingPlat(24,12,-2,0,0.025));for(let x=1;x<31;x++) grid[x][17]=30;}
            },
            previewMap:(t)=>{Game.loadMap(t);document.getElementById('preview-title').innerText=t.toUpperCase();},
            confirmMap:(t)=>{Game.loadMap(t);Game.startGame();},
            endGame:(winnerId)=>{if(state!=='GAME')return;AudioEngine.sfx.win();document.getElementById('victory-screen').classList.remove('hidden');document.getElementById('winner-name').innerText=entities[winnerId-1].config.name;document.getElementById('winner-name').style.color=entities[winnerId-1].config.color;AudioEngine.stopMusic();},
            restartGame:()=>{document.getElementById('victory-screen').classList.add('hidden');Game.startGame();}
        };
        const Editor={tool:1,rot:0,initGrid:()=>{grid=new Array(COLS).fill(0).map(()=>new Array(ROWS).fill(0));for(let i=0;i<COLS;i++){grid[i][0]=9;grid[i][ROWS-1]=9;}for(let i=0;i<ROWS;i++){grid[0][i]=9;grid[COLS-1][i]=9;}},setTool:(id)=>{if(id===3&&Editor.tool===3)Editor.rot=(Editor.rot+1)%4;else Editor.rot=0;Editor.tool=id;document.querySelectorAll('.btn-icon').forEach(b=>b.classList.remove('tool-selected'));document.getElementById('tool-'+id).classList.add('tool-selected');},interact:()=>{let{x,y}=mouse;if(x<=0||x>=COLS-1||y<=0||y>=ROWS-1)return;if(Editor.tool===3)grid[x][y]=30+Editor.rot;else if(Editor.tool===0){if(grid[x][y]!==9)grid[x][y]=0;}else grid[x][y]=Editor.tool;},clear:()=>{for(let x=1;x<COLS-1;x++)for(let y=1;y<ROWS-1;y++)grid[x][y]=0;}};
        const Renderer={
            drawBackground:(t)=>{
                const g=ctx.createLinearGradient(0,0,0,720);
                if(t==='neon'){g.addColorStop(0,'#0f172a');g.addColorStop(1,'#312e81');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);ctx.fillStyle='#1e1b4b'; bgElements.forEach(b=>{ctx.fillRect(b.x,720-b.y,b.w,b.y);ctx.fillStyle='#4f46e5';if(b.y>150)ctx.fillRect(b.x+10,730-b.y,10,10);ctx.fillStyle='#1e1b4b';});}
                else if(t==='magma'){g.addColorStop(0,'#450a0a');g.addColorStop(1,'#7f1d1d');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);ctx.fillStyle='#991b1b';ctx.beginPath();ctx.moveTo(0,720);ctx.lineTo(300,400);ctx.lineTo(600,720);ctx.lineTo(900,350);ctx.lineTo(1280,720);ctx.fill();}
                else if(t==='forest'){g.addColorStop(0,'#022c22');g.addColorStop(1,'#064e3b');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);ctx.fillStyle='#065f46'; bgElements.forEach(b=>{ctx.beginPath();ctx.moveTo(b.x,720);ctx.lineTo(b.x+40,720-b.h);ctx.lineTo(b.x+80,720);ctx.fill();});}
                else if(t==='sky'){g.addColorStop(0,'#0ea5e9');g.addColorStop(1,'#e0f2fe');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);ctx.fillStyle='white';ctx.globalAlpha=0.4; bgElements.forEach((b,i)=>{let off=Math.sin((frame+i*100)*0.005)*50;ctx.beginPath();ctx.arc(b.x+off,b.y,b.s,0,Math.PI*2);ctx.fill();});ctx.globalAlpha=1;}
                else if(t==='glacier'){g.addColorStop(0,'#1e3a8a');g.addColorStop(1,'#bfdbfe');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);ctx.fillStyle='white';ctx.globalAlpha=0.15; bgElements.forEach(b=>{ctx.beginPath();ctx.moveTo(b.x,720);ctx.lineTo(b.x+65,720-b.h);ctx.lineTo(b.x+130,720);ctx.fill();});ctx.globalAlpha=1;}
                else if(t==='void'){g.addColorStop(0,'#000000');g.addColorStop(1,'#4c1d95');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);ctx.fillStyle='white'; bgElements.forEach(b=>{ctx.fillRect(b.x,b.y,b.s,b.s);});}
                else {ctx.fillStyle='#020617';ctx.fillRect(0,0,1280,720);}
            },
            drawMap:()=>{for(let x=0;x<COLS;x++)for(let y=0;y<ROWS;y++){let id=grid[x][y];if(!id)continue;let px=x*TILE,py=y*TILE;if(id===1){ctx.fillStyle='#1e293b';ctx.fillRect(px,py,TILE,TILE);ctx.fillStyle='#0f172a';ctx.fillRect(px+2,py+2,36,36);ctx.strokeStyle='#3b82f6';ctx.lineWidth=1;ctx.strokeRect(px+4,py+4,32,32);}else if(id===4){ctx.fillStyle='#475569';ctx.fillRect(px,py,40,10);ctx.fillStyle='#000';ctx.fillRect(px,py,40,2);ctx.fillStyle='#94a3b8';ctx.fillRect(px+2,py+3,36,4);}else if(id===5){let w=Math.sin(frame*0.1+x)*4;ctx.fillStyle='#c2410c';ctx.fillRect(px,py+10,40,30);ctx.fillStyle='#ea580c';ctx.beginPath();ctx.moveTo(px,py+10);ctx.quadraticCurveTo(px+20,py+10+w,px+40,py+10);ctx.lineTo(px+40,py+40);ctx.lineTo(px,py+40);ctx.fill();}else if(id>=30)Renderer.drawSpike(px,py,id);else if(id===9){ctx.fillStyle='#000';ctx.fillRect(px,py,40,40);}} for(let mp of movingPlats)mp.update(),mp.draw(ctx);},drawSpike:(x,y,id)=>{ctx.fillStyle='#991b1b';ctx.beginPath();if(id===30){ctx.moveTo(x,y+40);ctx.lineTo(x+20,y);ctx.lineTo(x+40,y+40);}else if(id===31){ctx.moveTo(x,y);ctx.lineTo(x+40,y+20);ctx.lineTo(x,y+40);}else if(id===32){ctx.moveTo(x,y);ctx.lineTo(x+20,y+40);ctx.lineTo(x+40,y);}else{ctx.moveTo(x+40,y);ctx.lineTo(x,y+20);ctx.lineTo(x+40,y+40);}ctx.fill();},drawEditor:()=>{ctx.strokeStyle='rgba(255,255,255,0.03)';ctx.lineWidth=1;for(let i=0;i<=COLS;i++){ctx.beginPath();ctx.moveTo(i*TILE,0);ctx.lineTo(i*TILE,720);ctx.stroke();}for(let i=0;i<=ROWS;i++){ctx.beginPath();ctx.moveTo(0,i*TILE);ctx.lineTo(1280,i*TILE);ctx.stroke();}if(mouse.x>0&&mouse.x<COLS-1&&mouse.y>0&&mouse.y<ROWS-1){let px=mouse.x*TILE,py=mouse.y*TILE;ctx.strokeStyle='white';ctx.lineWidth=2;ctx.strokeRect(px,py,40,40);ctx.globalAlpha=0.5;if(Editor.tool===3)Renderer.drawSpike(px,py,30+Editor.rot);else{ctx.fillStyle=Editor.tool===0?'red':(Editor.tool===5?'orange':'white');ctx.fillRect(px+10,py+10,20,20);}ctx.globalAlpha=1;}},drawParticles:()=>{for(let i=particles.length-1;i>=0;i--){let p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life--;if(p.isSlash){ctx.strokeStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=10;ctx.lineWidth=2;ctx.beginPath();ctx.arc(p.x,p.y,25,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;}else{ctx.fillStyle=p.color;ctx.globalAlpha=p.life/30;ctx.fillRect(p.x,p.y,p.size,p.size);ctx.globalAlpha=1;}if(p.life<=0)particles.splice(i,1);}}};
        Game.init();
    </script>
</body>
</html>
