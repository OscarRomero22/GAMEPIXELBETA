<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Arena: Omega v3.0 - Multijugador P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

    <style>
        :root { --neon-blue: #06b6d4; --neon-pink: #d946ef; --neon-gold: #fbbf24; --neon-red: #ef4444; --neon-green: #22c55e; }
        body {
            background-color: #000; margin: 0; padding: 0; overflow: hidden; font-family: 'Rajdhani', sans-serif;
            user-select: none; display: flex; align-items: center; justify-content: center; height: 100vh; width: 100vw; color: white;
            background-image: radial-gradient(circle at center, #0f172a 0%, #000 100%);
            touch-action: none;
        }
        h1, h2, h3, .btn-neon, .stat-label { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        
        #game-container {
            position: absolute; width: 1280px; height: 720px;
            box-shadow: 0 0 120px rgba(0,0,0,0.9), 0 0 20px rgba(6, 182, 212, 0.1);
            background: #000; border-radius: 12px; border: 1px solid #1e293b; overflow: hidden;
            transform-origin: center center;
        }
        canvas { display: block; outline: none; } 
        
        .ui-screen { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; transition: all 0.3s ease; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; display: none !important; }
        
        .glass-panel { background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.98)); border: 1px solid rgba(255,255,255,0.08); border-top: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 50px rgba(0,0,0,0.6); backdrop-filter: blur(20px); border-radius: 16px; }

        @keyframes title-pulse { 0% { transform: scale(1); text-shadow: 0 0 20px rgba(6, 182, 212, 0.5); } 50% { transform: scale(1.02); text-shadow: 0 0 40px rgba(217, 70, 239, 0.8), 0 0 10px white; } 100% { transform: scale(1); text-shadow: 0 0 20px rgba(6, 182, 212, 0.5); } }
        .title-anim { animation: title-pulse 3s infinite ease-in-out; }
        .glitch-text { animation: glitch 0.3s linear infinite; font-weight: 900; color: #fff; text-shadow: 2px 0 #f00, -2px 0 #0ff; }
        @keyframes glitch { 2%, 64% { transform: translate(2px,0) skew(0deg); } 4%, 60% { transform: translate(-2px,0) skew(0deg); } 62% { transform: translate(0,0) skew(5deg); } }
        .alert-pulse { animation: alertAnim 0.2s infinite alternate; color: #ef4444; text-shadow: 0 0 20px #f00; font-family: 'Orbitron'; letter-spacing: 4px; }
        @keyframes alertAnim { from { opacity: 1; transform: scale(1); } to { opacity: 0.8; transform: scale(1.05); } }

        .btn-neon { background: linear-gradient(180deg, var(--neon-blue), #1e40af); border: none; padding: 14px 40px; color: white; font-weight: 900; text-transform: uppercase; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 0px rgba(0,0,0,0.5); border-top: 1px solid rgba(255,255,255,0.2); }
        .btn-neon:hover { transform: translateY(-3px) scale(1.05); filter: brightness(1.3); box-shadow: 0 0 30px var(--neon-blue); }
        
        .btn-diff { padding: 8px 0; font-family: 'Orbitron'; font-size: 0.7rem; font-weight: bold; flex: 1; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.4); color: #64748b; cursor: pointer; transition: all 0.2s; }
        .btn-diff:hover { background: rgba(255,255,255,0.1); color: white; }
        .btn-diff.active-easy { background: var(--neon-green); color: black; box-shadow: 0 0 10px var(--neon-green); border-color: white; }
        .btn-diff.active-normal { background: var(--neon-blue); color: white; box-shadow: 0 0 10px var(--neon-blue); border-color: white; }
        .btn-diff.active-hard { background: var(--neon-red); color: white; box-shadow: 0 0 10px var(--neon-red); border-color: white; }

        .m-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(15, 23, 42, 0.5); border: 2px solid var(--neon-blue); color: white; font-family: 'Orbitron'; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; user-select: none; backdrop-filter: blur(4px); transition: background 0.1s; }
        .m-btn:active { background: var(--neon-blue); color: black; box-shadow: 0 0 20px var(--neon-blue); }
        .m-btn-action { width: 90px; height: 90px; border-color: var(--neon-pink); font-size: 1rem; }
        .m-btn-action:active { background: var(--neon-pink); color: white; box-shadow: 0 0 20px var(--neon-pink); }
        .m-btn-shield { border-color: var(--neon-green); width: 70px; height: 70px;}
        .m-btn-shield:active { background: var(--neon-green); color: black; box-shadow: 0 0 20px var(--neon-green); }

        .armory-layout { display: flex; width: 100%; height: 100%; }
        .armory-sidebar { width: 380px; padding: 30px; padding-bottom: 150px; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); overflow-y: auto; }
        .armory-preview { flex: 1; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1e293b 0%, #000 80%); position: relative; }
        .tab-btn { padding: 15px; font-family: 'Orbitron'; font-weight: bold; text-align: center; cursor: pointer; background: #0f172a; border: 1px solid #334155; color: #64748b; transition: all 0.3s; clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%); }
        .tab-btn.active-p1 { background: var(--neon-blue); color: white; box-shadow: 0 0 15px var(--neon-blue); border-color: white; }
        .tab-btn.active-p2 { background: var(--neon-red); color: white; box-shadow: 0 0 15px var(--neon-red); border-color: white; }
        select, input[type="text"] { width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; border-radius: 4px; outline: none; font-family: 'Rajdhani', sans-serif; font-weight: bold; transition: all 0.2s; cursor: pointer; text-transform: uppercase; }
        input[type="color"] { width: 100%; height: 45px; border: none; border-radius: 4px; cursor: pointer; padding: 4px; background: #334155; }

        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .terminal-input { background: #111; border: 1px solid #fbbf24; color: #fbbf24; font-family: 'Orbitron'; padding: 15px; font-size: 1.2rem; text-align: center; outline: none; letter-spacing: 4px; }
        .custom-scroll::-webkit-scrollbar { width: 4px; } .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        #toast-msg { position: absolute; top: 10%; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(234, 179, 8, 0.95); color: #000; padding: 15px 40px; font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.5rem; border-radius: 4px; border: 2px solid #fff; box-shadow: 0 0 50px rgba(234, 179, 8, 0.8); opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 150; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%, 0 20%); }
        #toast-msg.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .victory-anim { animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes zoomIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body onclick="AudioEngine.start()" ontouchstart="AudioEngine.start()">

    <div id="game-container">
        <canvas id="gameCanvas" width="1280" height="720"></canvas>
        <div id="toast-msg">¬°PR√ìXIMAMENTE!</div>

        <div id="mobile-controls" class="hidden absolute inset-0 pointer-events-none z-40">
            <div class="absolute bottom-12 left-12 flex flex-col gap-2 pointer-events-auto opacity-70">
                <div class="flex justify-center"><button class="m-btn" id="m-up">‚ñ≤</button></div>
                <div class="flex gap-16"><button class="m-btn" id="m-left">‚óÄ</button><button class="m-btn" id="m-right">‚ñ∂</button></div>
            </div>
            <div class="absolute bottom-12 right-12 flex items-end gap-6 pointer-events-auto opacity-70">
                <button class="m-btn m-btn-shield" id="m-shield">ESCUDO</button>
                <button class="m-btn m-btn-action" id="m-atk">ATK</button>
            </div>
        </div>

        <div id="cinematic-screen" class="ui-screen hidden" style="background: #050505; z-index: 60;">
            <div class="w-3/4 max-w-4xl flex flex-col items-center">
                <h2 class="text-6xl font-black text-red-600 mb-8 glitch-text tracking-widest text-shadow-red" style="text-shadow: 0 0 20px #ef4444;">AMENAZA DETECTADA</h2>
                <div id="cinematic-text" class="text-2xl font-mono text-slate-300 leading-relaxed min-h-[250px] text-center"></div>
                <button onclick="Game.skipCinematic()" class="mt-16 py-3 px-8 border border-slate-700 text-slate-400 hover:text-white hover:bg-slate-800 font-bold tracking-widest transition-all">PRESIONA PARA SALTAR &gt;&gt;</button>
            </div>
        </div>

        <div id="menu-screen" class="ui-screen">
            <div class="flex flex-col items-center justify-center relative z-10 w-full h-full">
                <h1 class="title-anim text-9xl font-black mb-0 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 italic tracking-tighter p-4 text-center leading-tight">PIXEL ULTRA</h1>
                <div class="flex items-center gap-4 mb-16">
                    <div class="h-px w-20 bg-slate-700"></div><p class="text-slate-400 tracking-[1.5em] font-bold text-xs uppercase">OMEGA 4.0 - MULTIJUGADOR GITHUB</p><div class="h-px w-20 bg-slate-700"></div>
                </div>
                <div class="flex flex-col gap-4 items-center w-full max-w-md">
                    <button onclick="SFX.ui(); Game.startPvPMode()" class="btn-neon text-3xl px-20 py-5 tracking-widest w-full hover:scale-105 transition-transform">VS. DUELO (LOCAL)</button>
                    <button onclick="SFX.ui(); Game.startCpuMode()" class="btn-neon w-full py-4 text-sm flex items-center justify-center gap-2 border-yellow-500" style="--neon-blue: #fbbf24; color: #fbbf24; background: linear-gradient(180deg, #d97706, #451a03);"><span>ü§ñ</span> 1 VS CPU</button>
                    <button onclick="Game.openCoopModal()" class="btn-neon w-full py-4 text-sm flex items-center justify-center gap-2 border-red-600" style="--neon-blue: #ef4444; color: #fecaca; background: linear-gradient(180deg, #7f1d1d, #450a0a);"><span>‚ò†Ô∏è</span> COOPERATIVO (LOCAL)</button>
                    
                    <button onclick="SFX.ui(); NetP2P.abrirMenu()" class="btn-neon w-full py-4 text-sm flex items-center justify-center gap-2 border-indigo-500" style="--neon-blue: #6366f1; color: #e0e7ff; background: linear-gradient(180deg, #3730a3, #1e1b4b);"><span>üåê</span> MULTIJUGADOR ONLINE (P2P)</button>

                    <div class="flex gap-4 w-full">
                        <button onclick="SFX.ui(); Game.goToCustom()" class="btn-neon bg-gradient-to-b from-purple-500 to-purple-900 flex-1 py-4 text-sm border-purple-400" style="--neon-blue: #d946ef">ARMER√çA</button>
                        <button onclick="SFX.ui(); Game.showToast('MODO EDITOR BLOQUEADO POR MANTENIMIENTO')" class="btn-neon bg-gradient-to-b from-slate-700 to-slate-900 flex-1 py-4 text-sm border-slate-500" style="--neon-blue: #94a3b8"><span>‚úèÔ∏è</span> EDITOR</button>
                    </div>
                </div>
                <button onclick="Game.openUpdateModal()" class="absolute bottom-8 right-8 text-slate-500 text-xs font-bold tracking-widest border border-slate-700 px-4 py-2 hover:bg-slate-800 hover:text-white transition-all flex items-center gap-2"><span>‚ìò</span> INFO VERSI√ìN</button>
            </div>
        </div>

        <div id="p2p-screen" class="ui-screen hidden">
            <div class="glass-panel w-[600px] p-8 flex flex-col items-center">
                <h2 class="text-4xl font-black text-indigo-400 mb-6 tracking-widest text-center"><span class="text-2xl">üåê</span> CONEXI√ìN ONLINE</h2>
                
                <div class="w-full flex gap-4 mb-8">
                    <div class="flex-1 bg-slate-900 p-4 border border-slate-700 rounded text-center">
                        <h3 class="text-white font-bold mb-2">1. CREAR SALA</h3>
                        <input type="text" id="crear-sala-input" placeholder="Escribe un c√≥digo..." class="w-full mb-2 p-2 text-center" maxlength="10">
                        <button onclick="NetP2P.crearSala()" class="btn-neon w-full py-2 text-sm border-indigo-500" style="--neon-blue: #6366f1;">CREAR</button>
                    </div>
                    <div class="flex-1 bg-slate-900 p-4 border border-slate-700 rounded text-center">
                        <h3 class="text-white font-bold mb-2">2. UNIRSE</h3>
                        <input type="text" id="unirse-sala-input" placeholder="C√≥digo de tu amigo..." class="w-full mb-2 p-2 text-center" maxlength="10">
                        <button onclick="NetP2P.unirseSala()" class="btn-neon w-full py-2 text-sm border-green-500" style="--neon-blue: #22c55e;">BUSCAR Y UNIRSE</button>
                    </div>
                </div>
                
                <div id="p2p-status" class="text-yellow-400 font-mono text-sm h-6 mb-4 text-center"></div>
                <button onclick="SFX.ui(); Game.goToMenu()" class="text-slate-500 hover:text-white font-bold py-2 w-full uppercase tracking-widest transition-colors border-t border-white/10 pt-4">‚Üê Volver al Men√∫</button>
            </div>
        </div>

        <div id="lobby-screen" class="ui-screen hidden">
            <div class="glass-panel w-[500px] p-8 flex flex-col items-center">
                <h2 class="text-3xl font-black text-white mb-2 tracking-widest text-center">SALA ONLINE</h2>
                <h3 id="lobby-room-code" class="text-xl font-mono text-indigo-400 mb-8 tracking-widest border border-indigo-500/50 px-4 py-1 rounded">C√ìDIGO: -----</h3>
                
                <div class="flex justify-between w-full mb-8 px-4">
                    <div class="flex flex-col items-center gap-2">
                        <div class="w-20 h-20 bg-blue-900/50 border-2 border-cyan-400 rounded-lg flex items-center justify-center text-3xl">ü§ñ</div>
                        <span id="lobby-p1-name" class="font-black text-cyan-400 tracking-wider">JUGADOR 1</span>
                    </div>
                    <div class="text-4xl font-black text-slate-600 mt-4">VS</div>
                    <div class="flex flex-col items-center gap-2">
                        <div id="lobby-p2-avatar" class="w-20 h-20 bg-slate-800 border-2 border-slate-600 rounded-lg flex items-center justify-center text-3xl animate-pulse">‚è≥</div>
                        <span id="lobby-p2-name" class="font-black text-slate-500 tracking-wider">ESPERANDO AMIGO...</span>
                    </div>
                </div>

                <div id="lobby-host-controls" class="w-full hidden">
                    <button onclick="NetP2P.abrirSeleccionMapa()" class="btn-neon w-full py-4 text-lg mb-2">ELEGIR ARENA / INICIAR</button>
                    <button onclick="NetP2P.iniciarCoopOnline()" class="btn-neon w-full py-4 text-lg border-red-500" style="--neon-blue: #ef4444; background: linear-gradient(180deg, #991b1b, #450a0a);">INICIAR CO-OP (BOSS)</button>
                </div>
                <div id="lobby-client-controls" class="text-yellow-400 font-mono text-sm text-center mb-4 hidden">
                    EL ANFITRI√ìN EST√Å ELIGIENDO EL MAPA...
                </div>

                <button onclick="NetP2P.salirLobby()" class="text-red-500 hover:text-red-400 font-bold py-2 mt-4 uppercase tracking-widest transition-colors">ABANDONAR SALA</button>
            </div>
        </div>

        <div id="select-screen" class="ui-screen hidden" style="background: rgba(2,6,23,0.3); flex-direction: row; justify-content: flex-start;">
            <div class="glass-panel h-full w-96 p-8 border-r border-white/5 z-10 flex flex-col">
                <h2 class="text-4xl font-black mb-4 text-white tracking-widest border-b-2 border-cyan-500/50 pb-4">ARENAS</h2>
                
                <div id="cpu-difficulty-panel" class="hidden mb-6 border-b border-white/10 pb-4">
                     <h3 class="text-cyan-400 font-bold text-xs tracking-widest mb-2 flex items-center gap-2"><span class="text-lg">ü§ñ</span> NIVEL DE AMENAZA (CPU)</h3>
                     <div class="flex gap-2">
                         <button id="diff-easy" onclick="Game.setDifficulty('easy')" class="btn-diff">CADETE</button>
                         <button id="diff-normal" onclick="Game.setDifficulty('normal')" class="btn-diff active-normal">SOLDADO</button>
                         <button id="diff-hard" onclick="Game.setDifficulty('hard')" class="btn-diff">PESADILLA</button>
                     </div>
                </div>

                <div id="arena-list" class="space-y-4 flex-1 overflow-y-auto custom-scroll pr-3">
                    <button onmouseenter="Game.previewMap('clash'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('clash')" class="w-full text-left p-5 bg-black/90 hover:bg-slate-900/90 border border-white/20 hover:border-white rounded-lg transition-all group overflow-hidden relative">
                         <div class="absolute inset-0 bg-gradient-to-r from-transparent via-red-500/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                         <div class="font-bold text-xl text-white glitch-text">CHOQUE DE REALIDADES</div> 
                         <div class="text-xs text-slate-400">‚ö†Ô∏è Inestabilidad Extrema. Supervivencia.</div>
                    </button>
                    <button onmouseenter="Game.previewMap('sky'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('sky')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-yellow-900/60 border border-slate-700 hover:border-yellow-500 rounded-lg transition-all"><div class="font-bold text-xl text-yellow-300">SKY SANCTUARY</div> <div class="text-xs text-slate-400">Gravedad Baja + Viento.</div></button>
                    <button onmouseenter="Game.previewMap('acid'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('acid')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-green-900/60 border border-slate-700 hover:border-green-500 rounded-lg transition-all"><div class="font-bold text-xl text-green-400">ACID FACTORY</div> <div class="text-xs text-slate-400">√Åcido corrosivo variable.</div></button>
                    <button onmouseenter="Game.previewMap('time'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('time')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-blue-900/60 border border-slate-700 hover:border-blue-500 rounded-lg transition-all"><div class="font-bold text-xl text-blue-400">TIME WARP</div> <div class="text-xs text-slate-400">El tiempo se altera.</div></button>
                    <button onmouseenter="Game.previewMap('magma'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('magma')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-red-900/60 border border-slate-700 hover:border-red-500 rounded-lg transition-all"><div class="font-bold text-xl text-red-400">MAGMA CORE</div></button>
                    <button onmouseenter="Game.previewMap('void'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('void')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-purple-900/60 border border-slate-700 hover:border-purple-400 rounded-lg transition-all"><div class="font-bold text-xl text-purple-300">THE VOID</div></button>
                    <button onmouseenter="Game.previewMap('neon'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('neon')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-cyan-900/60 border border-slate-700 hover:border-cyan-400 rounded-lg transition-all"><div class="font-bold text-xl text-cyan-300">NEON CITY</div></button>
                    <button onmouseenter="Game.previewMap('forest'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('forest')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-green-900/60 border border-slate-700 hover:border-green-400 rounded-lg transition-all"><div class="font-bold text-xl text-green-500">DEEP FOREST</div></button>
                    
                    <button id="btn-secret-level" onclick="Game.openSecretModal()" class="w-full text-center p-3 bg-black/40 border border-dashed border-yellow-700 rounded-lg text-yellow-700 hover:text-yellow-500 hover:border-yellow-500 transition-all">
                        <span class="text-sm font-bold tracking-widest">‚ö†Ô∏è ACCESO CLASIFICADO</span>
                    </button>
                </div>
                <button onclick="SFX.ui(); Game.goToMenu()" class="mt-4 py-4 text-slate-500 hover:text-white tracking-widest font-bold transition-colors w-full border-t border-white/5 uppercase">‚Üê Volver al Men√∫</button>
            </div>
            <div class="flex-1 h-full pointer-events-none flex items-center justify-center relative">
                <h2 id="preview-title" class="text-9xl font-black text-white/5 uppercase tracking-widest drop-shadow-xl select-none absolute">PREVIEW</h2>
            </div>
        </div>

        <div id="mode-modal" class="modal-overlay">
            <div class="glass-panel w-[400px] p-8 border-t-4 border-t-cyan-500 flex flex-col gap-4">
                <h2 class="text-2xl font-black text-cyan-400 mb-4 text-center">MODO DE JUEGO</h2>
                <button onclick="Game.startSelectedMap()" class="btn-neon w-full py-4 text-lg">MUERTE S√öBITA</button>
                <button onclick="document.getElementById('mode-modal').classList.remove('active')" class="mt-4 py-3 bg-slate-800 text-white font-bold rounded w-full hover:bg-slate-700 transition-colors">CANCELAR</button>
            </div>
        </div>

        <div id="coop-modal" class="modal-overlay z-50">
            <div class="glass-panel w-[450px] p-8 border-t-4 border-t-red-600 flex flex-col gap-4">
                <h2 class="text-3xl font-black text-red-500 mb-4 text-center tracking-widest">MODO CO-OP</h2>
                <button onclick="Game.startCinematic()" class="btn-neon w-full py-4 text-lg border-red-500" style="--neon-blue: #ef4444;">LOCAL (MISMO DISPOSITIVO)</button>
                <button onclick="document.getElementById('coop-modal').classList.remove('active')" class="mt-4 py-3 bg-slate-800 text-white font-bold rounded w-full hover:bg-slate-700 transition-colors">CANCELAR</button>
            </div>
        </div>

        <div id="secret-modal" class="modal-overlay">
            <div class="glass-panel w-[500px] p-8 border-t-4 border-t-yellow-500 flex flex-col gap-4">
                <h2 class="text-2xl font-black text-yellow-500 text-center">SEGURIDAD</h2>
                <input type="text" id="secret-pass" class="terminal-input" placeholder="CONTRASE√ëA..." autocomplete="off">
                <div id="secret-hint" class="text-xs text-red-500 font-mono h-4 text-center"></div>
                <div class="flex gap-4"><button onclick="Game.checkSecret()" class="flex-1 btn-neon text-sm">ACCEDER</button><button onclick="Game.closeSecretModal()" class="flex-1 btn-diff text-sm hover:text-white">CANCELAR</button></div>
            </div>
        </div>

        <div id="custom-screen" class="ui-screen hidden">
            <div class="glass-panel w-[90%] h-[85%] flex flex-col relative overflow-hidden">
                <div class="flex border-b border-white/10">
                    <div id="tab-p1" onclick="Armory.switchPlayer(1)" class="tab-btn flex-1 active-p1">JUGADOR 1</div>
                    <div id="tab-p2" onclick="Armory.switchPlayer(2)" class="tab-btn flex-1">JUGADOR 2</div>
                </div>
                <div class="armory-layout">
                    <div class="armory-sidebar custom-scroll">
                        <div class="mb-4"><label class="text-slate-400 text-xs font-bold">NOMBRE</label><input type="text" id="arm-name" class="mt-1 text-lg" oninput="Armory.updateCurrent()"></div>
                        <div class="flex flex-col gap-6">
                            <div class="input-group"><label>Color</label><input type="color" id="arm-color" oninput="Armory.updateCurrent()"></div>
                            <div class="input-group"><label>Casco</label><select id="arm-helmet" onchange="Armory.updateCurrent()"><option value="none">Sin Casco</option><option value="tactical">Tactical Visor</option><option value="oni">Oni Mask</option><option value="viking">Cyber Viking</option><option value="samurai">Samurai Helmet</option><option value="skull">Reaper Skull</option><option value="cyclops">Mono-Eye</option><option value="hood">Assassin Hood</option><option value="pilot">Ace Pilot</option><option value="demon">Void Demon</option></select></div>
                            <div class="input-group"><label>Pecho</label><select id="arm-armor" onchange="Armory.updateCurrent()"><option value="none">Standard Issue</option><option value="heavy">Heavy Plating</option><option value="stealth">Stealth Suit</option><option value="knight">Neo-Knight</option><option value="nano">Nano Fiber</option><option value="juggernaut">Juggernaut</option><option value="cyberninja">Cyber-Ninja</option></select></div>
                            <div class="input-group"><label>Espalda</label><select id="arm-back" onchange="Armory.updateCurrent()"><option value="none">---</option><option value="cape">Nano Cape</option><option value="wings">Energy Wings</option><option value="jetpack">Thruster Pack</option><option value="battery">Power Cell</option><option value="spider">Mech Legs</option><option value="halo">Angel Halo</option></select></div>
                            <div class="input-group"><label>Arma</label><select id="arm-weapon" onchange="Armory.updateCurrent()"><option value="sword">Energy Sword</option><option value="katana">Nanocarbon Katana</option><option value="scythe">Void Scythe</option><option value="hammer">Gravity Hammer</option><option value="spear">Laser Spear</option><option value="daggers">Dual Daggers</option><option value="laseraxe">Laser Axe</option><option value="whip">Plasma Whip</option><option value="fists">Power Fists</option></select></div>
                        </div>
                    </div>
                    <div class="armory-preview">
                        <div class="absolute top-4 right-4 text-right"><div class="text-2xl font-black text-white" id="preview-name-display">NOMBRE</div></div>
                        <canvas id="armory-canvas" width="500" height="500"></canvas>
                    </div>
                </div>
                <div class="absolute bottom-0 w-full p-4 border-t border-white/10 bg-black/80 flex justify-between items-center z-10">
                    <button onclick="SFX.ui(); Game.goToMenu()" class="text-slate-400 hover:text-white font-bold px-6">DESCARTAR</button>
                    <button onclick="SFX.ui(); Game.saveAndExit()" class="btn-neon px-12 py-3 text-lg">CONFIRMAR</button>
                </div>
            </div>
        </div>

        <div id="game-hud" class="absolute top-0 w-full p-8 flex justify-between hidden pointer-events-none z-30">
            <div class="w-1/3">
                <div class="flex justify-between text-cyan-400 font-black text-lg mb-2 tracking-wider"><span id="p1-name-hud">JUGADOR 1</span><span id="hp-txt-1">100%</span></div>
                <div class="h-6 bg-slate-900/80 rounded-sm border-2 border-cyan-500/50 overflow-hidden"><div id="hp-bar-1" class="h-full bg-gradient-to-r from-cyan-400 to-blue-600 w-full transition-all duration-200"></div></div>
            </div>
            <div class="flex flex-col items-center relative w-1/3">
                <button onclick="SFX.ui(); Game.goToMenu()" class="pointer-events-auto px-6 py-2 bg-black/40 text-white/40 hover:bg-red-900/80 hover:text-white rounded border border-white/10 text-xs font-bold transition-all backdrop-blur-sm mb-2">ABANDONAR</button>
                <div id="clash-timer-hud" class="text-white font-mono font-bold text-xs opacity-0 transition-opacity text-shadow-red glitch-text">CAMBIO: 15s</div>
                <div id="clash-mode-hud" class="text-red-500 font-black text-sm opacity-0">MODO NORMAL</div>
                <div id="coop-wave-hud" class="text-red-500 font-black text-2xl hidden tracking-widest text-shadow-red">RONDA 1</div>
                
                <div id="boss-dialogue" class="absolute top-32 w-[600px] text-red-500 font-black text-xl tracking-widest glitch-text hidden text-center drop-shadow-xl" style="text-shadow: 0 0 10px #ef4444;">
                    ULTRON: DIALOGO AQUI
                </div>

                <div id="final-warning" class="hidden text-3xl font-black text-red-600 absolute top-20 text-center w-[600px] alert-pulse bg-black/80 p-6 border-2 border-red-600 rounded-xl z-50">¬°ADVERTENCIA!<br>COLAPSO DE REALIDAD</div>
            </div>
            <div class="w-1/3">
                <div class="flex justify-between text-red-400 font-black text-lg mb-2 tracking-wider"><span id="p2-name-hud">JUGADOR 2</span><span id="hp-txt-2">100%</span></div>
                <div class="h-6 bg-slate-900/80 rounded-sm border-2 border-red-500/50 overflow-hidden"><div id="hp-bar-2" class="h-full bg-gradient-to-l from-red-500 to-orange-600 w-full transition-all duration-200 float-right"></div></div>
            </div>
        </div>

        <div id="victory-screen" class="ui-screen hidden z-50" style="background: rgba(0,0,0,0.9);">
            <div class="victory-anim flex flex-col items-center">
                <h1 id="vic-title" class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-4 uppercase italic text-center drop-shadow-lg">¬°VICTORIA!</h1>
                <h2 id="winner-name" class="text-8xl font-black text-white mb-10 drop-shadow-xl uppercase tracking-tighter text-center max-w-5xl">NOMBRE</h2>
                <div class="flex gap-6"><button onclick="SFX.ui(); Game.restartGame()" class="btn-neon text-lg">RE-MATCH</button><button onclick="SFX.ui(); Game.goToMenu()" class="px-10 py-4 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded transition-colors">Men√∫</button></div>
            </div>
        </div>
        
        <div id="update-modal" class="modal-overlay">
            <div class="glass-panel w-[600px] p-8 border-t-4 border-t-cyan-500 flex flex-col gap-4">
                <h2 class="text-2xl font-black text-cyan-400 mb-2">OMEGA 4.0 RELEASE</h2>
                <div class="space-y-4 font-mono text-sm text-slate-300 border-b border-white/10 pb-4">
                    <p>¬°Multijugador Totalmente Online!</p>
                    <ul class="list-disc pl-5 text-gray-400">
                        <li><strong>C√ìDIGOS DE SALA:</strong> Con√©ctate con amigos desde cualquier parte usando PeerJS directo desde GitHub.</li>
                        <li><strong>BANDA SONORA √âPICA:</strong> M√∫sica completa de 2 minutos inspirada en Asgore.</li>
                        <li><strong>CINEM√ÅTICA CO-OP:</strong> Intro inmersiva con efectos de viento y temblores.</li>
                    </ul>
                </div>
                <button onclick="document.getElementById('update-modal').classList.remove('active')" class="mt-4 py-3 bg-slate-800 hover:bg-slate-700 transition-colors text-white font-bold rounded w-full">CERRAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- ESCALADO RESPONSIVO ---
        function resizeGame() {
            const container = document.getElementById('game-container');
            const scale = Math.min(window.innerWidth / 1280, window.innerHeight / 720);
            container.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', resizeGame);
        window.addEventListener('orientationchange', resizeGame);
        resizeGame();

        // --- SISTEMA MULTIJUGADOR P2P GITHUB (NUEVO) ---
        const NetP2P = {
            peer: null, conn: null, esHost: false, activo: false,
            
            abrirMenu: () => {
                Game.showScreen('p2p-screen');
                document.getElementById('p2p-status').innerText = "LISTO PARA CONECTAR";
            },

            crearSala: () => {
                SFX.ui();
                let input = document.getElementById('crear-sala-input').value.toUpperCase();
                if(input.length < 3) return document.getElementById('p2p-status').innerText = "EL C√ìDIGO DEBE TENER AL MENOS 3 LETRAS.";
                
                document.getElementById('p2p-status').innerText = "CREANDO SALA...";
                let hostId = 'pixelultra-v3-' + input;
                
                NetP2P.peer = new Peer(hostId);
                NetP2P.peer.on('open', (id) => {
                    NetP2P.esHost = true;
                    NetP2P.activo = true;
                    Game.showScreen('lobby-screen');
                    document.getElementById('lobby-room-code').innerText = "C√ìDIGO: " + input;
                    document.getElementById('lobby-p1-name').innerText = p1Config.name;
                    document.getElementById('lobby-p2-name').innerText = "ESPERANDO AMIGO...";
                    document.getElementById('lobby-host-controls').classList.add('hidden');
                });

                NetP2P.peer.on('connection', (connection) => {
                    NetP2P.conn = connection;
                    NetP2P.configurarEventosConexion();
                    // El host avisa que recibi√≥ al jugador y manda su config
                    NetP2P.conn.on('open', () => {
                        NetP2P.conn.send({ type: 'welcome', p1Config: p1Config });
                    });
                });

                NetP2P.peer.on('error', (err) => {
                    document.getElementById('p2p-status').innerText = "ERROR: " + err.type;
                });
            },

            unirseSala: () => {
                SFX.ui();
                let input = document.getElementById('unirse-sala-input').value.toUpperCase();
                if(input.length < 3) return document.getElementById('p2p-status').innerText = "INGRESA UN C√ìDIGO V√ÅLIDO.";
                
                document.getElementById('p2p-status').innerText = "BUSCANDO SALA...";
                let hostId = 'pixelultra-v3-' + input;
                
                NetP2P.peer = new Peer();
                NetP2P.peer.on('open', () => {
                    NetP2P.conn = NetP2P.peer.connect(hostId);
                    NetP2P.conn.on('open', () => {
                        NetP2P.esHost = false;
                        NetP2P.activo = true;
                        Game.showScreen('lobby-screen');
                        document.getElementById('lobby-room-code').innerText = "C√ìDIGO: " + input;
                        document.getElementById('lobby-p2-name').innerText = p1Config.name; // El cliente es P2
                        document.getElementById('lobby-client-controls').classList.remove('hidden');
                        
                        // Mandamos nuestra config al Host
                        NetP2P.conn.send({ type: 'clientJoined', p2Config: p1Config });
                        NetP2P.configurarEventosConexion();
                    });
                });
                NetP2P.peer.on('error', (err) => {
                    document.getElementById('p2p-status').innerText = "NO SE ENCONTR√ì LA SALA. REVISA EL C√ìDIGO.";
                });
            },

            configurarEventosConexion: () => {
                NetP2P.conn.on('data', (data) => {
                    if(data.type === 'clientJoined') {
                        // El Host recibe los datos del Cliente
                        SFX.win();
                        p2Config = data.p2Config;
                        document.getElementById('lobby-p2-name').innerText = p2Config.name;
                        document.getElementById('lobby-p2-name').className = "font-black text-red-500 tracking-wider";
                        document.getElementById('lobby-p2-avatar').innerText = "ü•∑";
                        document.getElementById('lobby-p2-avatar').className = "w-20 h-20 bg-red-900/50 border-2 border-red-500 rounded-lg flex items-center justify-center text-3xl";
                        document.getElementById('lobby-host-controls').classList.remove('hidden');
                    }
                    if(data.type === 'welcome') {
                        // El Cliente recibe los datos del Host
                        p1Config = data.p1Config;
                        document.getElementById('lobby-p1-name').innerText = p1Config.name;
                    }
                    if(data.type === 'startMap') {
                        isCoop = false; isCpuMode = false;
                        Game.loadMap(data.mapa);
                        Game.startGame();
                    }
                    if(data.type === 'startCoop') {
                        Game.startCinematic();
                    }
                    if(data.type === 'move') {
                        // Recibir movimiento del rival
                        let miId = NetP2P.esHost ? 1 : 2; 
                        let enemyId = NetP2P.esHost ? 2 : 1;
                        let enemy = entities.find(e => e.id === enemyId);
                        if (enemy) {
                            enemy.x = data.x;
                            enemy.y = data.y;
                            enemy.animFrame = data.animFrame;
                            enemy.facingRight = data.facingRight;
                        }
                    }
                });
            },

            abrirSeleccionMapa: () => { SFX.ui(); isCoop = false; isCpuMode = false; Game.showScreen('select-screen'); },
            iniciarCoopOnline: () => {
                SFX.ui();
                NetP2P.conn.send({ type: 'startCoop' });
                Game.startCinematic();
            },
            salirLobby: () => {
                SFX.ui();
                if(NetP2P.peer) { NetP2P.peer.destroy(); NetP2P.peer = null; }
                NetP2P.activo = false; NetP2P.esHost = false;
                Game.goToMenu();
            }
        };

        // --- AUDIO ENGINE (TEMA COMPLETO "ASGORE" - 2 MINUTOS) ---
        const AudioEngine={ctx:null,isEnabled:false,masterGain:null, musicInterval:null, ambientSources:[],
            start:()=>{if(!AudioEngine.ctx){AudioEngine.ctx=new(window.AudioContext||window.webkitAudioContext)();AudioEngine.isEnabled=true;AudioEngine.masterGain=AudioEngine.ctx.createGain();AudioEngine.masterGain.gain.value=0.3;AudioEngine.masterGain.connect(AudioEngine.ctx.destination);}if(AudioEngine.ctx.state==='suspended')AudioEngine.ctx.resume();},
            playTone:(f,t,d,v=0.1)=>{if(!AudioEngine.isEnabled)return;const o=AudioEngine.ctx.createOscillator(),g=AudioEngine.ctx.createGain();o.type=t;o.frequency.setValueAtTime(f,AudioEngine.ctx.currentTime);g.gain.setValueAtTime(v,AudioEngine.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,AudioEngine.ctx.currentTime+d);o.connect(g);g.connect(AudioEngine.masterGain);o.start();o.stop(AudioEngine.ctx.currentTime+d);},
            noise:(dur, type)=>{
                if(!AudioEngine.isEnabled)return;
                const b=AudioEngine.ctx.createBuffer(1,AudioEngine.ctx.sampleRate*dur,AudioEngine.ctx.sampleRate);
                const d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;
                const s=AudioEngine.ctx.createBufferSource();s.buffer=b;
                const f=AudioEngine.ctx.createBiquadFilter();
                f.type=type==='wind'?'lowpass':(type==='snare'?'highpass':'bandpass');
                f.frequency.value=type==='wind'?150:(type==='snare'?1500:60);
                const g=AudioEngine.ctx.createGain();g.gain.setValueAtTime(0,AudioEngine.ctx.currentTime);
                if(type==='snare'){g.gain.setValueAtTime(0.15,AudioEngine.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,AudioEngine.ctx.currentTime+dur);}
                else{g.gain.linearRampToValueAtTime(type==='wind'?0.4:1.2,AudioEngine.ctx.currentTime+dur*0.2);g.gain.linearRampToValueAtTime(0,AudioEngine.ctx.currentTime+dur);}
                s.connect(f);f.connect(g);g.connect(AudioEngine.masterGain);s.start();
                if(type!=='snare') AudioEngine.ambientSources.push(s);
            },
            stopAmbient:()=>{AudioEngine.ambientSources.forEach(s=>{try{s.stop()}catch(e){}});AudioEngine.ambientSources=[];},
            
            playBossMusic:()=>{
                if(!AudioEngine.isEnabled)return;
                AudioEngine.stopMusic();
                
                const f = { _:0, Fs2:92.5,G2:98,A2:110,B2:123.47, Cs3:138.59,D3:146.83,E3:164.81,Fs3:174.61,G3:196,A3:220,As3:233.08,B3:246.94, Cs4:277.18,D4:293.66,E4:329.63,Fs4:369.99,G4:392,A4:440,As4:466.16,B4:493.88, Cs5:554.37,D5:587.33,E5:659.25,Fs5:739.99,G5:783.99,A5:880,B5:987.77 };
                const m_intro = [f.B3,f.D4,f.Fs4,f.B4, f.D5,f.B4,f.Fs4,f.D4, f.A3,f.Cs4,f.E4,f.A4, f.Cs5,f.A4,f.E4,f.Cs4, f.G3,f.B3,f.D4,f.G4, f.B4,f.G4,f.D4,f.B3, f.Fs3,f.As3,f.Cs4,f.Fs4, f.As4,f.Fs4,f.Cs4,f.As3];
                const b_intro = [f.B2,f._,f._,f._, f._,f._,f._,f._, f.A2,f._,f._,f._, f._,f._,f._,f._, f.G2,f._,f._,f._, f._,f._,f._,f._, f.Fs2,f._,f._,f._, f._,f._,f._,f._];
                const m_A1 = [f.B4,f._,f.B4,f._, f.Fs4,f._,f.G4,f._, f.A4,f._,f.B4,f._, f.Fs4,f._,f.E4,f.D4, f.D5,f._,f.D5,f._, f.A4,f._,f.B4,f._, f.A4,f._,f.G4,f._, f.Fs4,f._,f.D4,f.E4];
                const m_A2 = [f.B4,f._,f.B4,f._, f.Fs4,f._,f.G4,f._, f.A4,f._,f.B4,f._, f.Fs4,f._,f.E4,f.D4, f.E4,f._,f.E4,f._, f.Fs4,f._,f.G4,f._, f.Fs4,f._,f.E4,f._, f.D4,f._,f.Cs4,f._];
                const b_A  = [f.B2,f.B2,f.B2,f.B2, f.B2,f.B2,f.B2,f.B2, f.G2,f.G2,f.G2,f.G2, f.G2,f.G2,f.G2,f.G2, f.D3,f.D3,f.D3,f.D3, f.D3,f.D3,f.D3,f.D3, f.A2,f.A2,f.A2,f.A2, f.A2,f.A2,f.A2,f.A2];
                const m_B1 = [f.Fs4,f._,f.Fs4,f.D4, f.Fs4,f._,f.Fs4,f.D4, f.G4,f._,f.G4,f.E4, f.G4,f._,f.G4,f.E4, f.A4,f._,f.A4,f.Fs4, f.A4,f._,f.A4,f.Fs4, f.B4,f._,f.B4,f.A4, f.Cs5,f._,f.D5,f._];
                const b_B  = [f.B2,f.B2,f.B2,f.B2, f.B2,f.B2,f.B2,f.B2, f.A2,f.A2,f.A2,f.A2, f.A2,f.A2,f.A2,f.A2, f.G2,f.G2,f.G2,f.G2, f.G2,f.G2,f.G2,f.G2, f.Fs2,f.Fs2,f.Fs2,f.Fs2, f.Fs2,f.Fs2,f.Fs2,f.Fs2];
                const m_C1 = [f.D5,f._,f._,f._, f.Cs5,f._,f._,f._, f.B4,f._,f._,f._, f.A4,f._,f._,f._, f.G4,f._,f._,f._, f.Fs4,f._,f._,f._, f.E4,f._,f._,f._, f.D4,f._,f.E4,f.Fs4];
                const m_C2 = [f.D5,f._,f._,f._, f.E5,f._,f._,f._, f.Fs5,f._,f._,f._, f.A5,f._,f._,f._, f.G5,f._,f._,f._, f.Fs5,f._,f._,f._, f.E5,f._,f._,f._, f.Fs5,f._,f._,f._];
                const b_C1 = [f.G2,f.G2,f.G2,f.G2, f.G2,f.G2,f.G2,f.G2, f.D3,f.D3,f.D3,f.D3, f.D3,f.D3,f.D3,f.D3, f.A2,f.A2,f.A2,f.A2, f.A2,f.A2,f.A2,f.A2, f.B2,f.B2,f.B2,f.B2, f.B2,f.B2,f.B2,f.B2];
                const b_C2 = [f.G2,f.G2,f.G2,f.G2, f.G2,f.G2,f.G2,f.G2, f.D3,f.D3,f.D3,f.D3, f.D3,f.D3,f.D3,f.D3, f.A2,f.A2,f.A2,f.A2, f.A2,f.A2,f.A2,f.A2, f.Fs2,f.Fs2,f.Fs2,f.Fs2, f.Fs2,f.Fs2,f.Fs2,f.Fs2];
                const m_D1 = [f.B4,f._,f._,f._, f._,f._,f._,f._, f.D5,f._,f._,f._, f._,f._,f._,f._, f.A4,f._,f._,f._, f._,f._,f._,f._, f._,f._,f._,f._, f._,f._,f._,f._];
                const m_D2 = [f.G4,f._,f._,f._, f._,f._,f._,f._, f.Fs4,f._,f._,f._, f.D4,f._,f._,f._, f.E4,f._,f._,f._, f._,f._,f._,f._, f._,f._,f._,f._, f._,f._,f._,f._];
                const b_D  = [f.B2,f._,f._,f._, f.B2,f._,f._,f._, f.G2,f._,f._,f._, f.G2,f._,f._,f._, f.D3,f._,f._,f._, f.D3,f._,f._,f._, f.A2,f._,f._,f._, f.A2,f._,f._,f._];
                const m_E  = [f.B4,f.Cs5,f.D5,f.E5, f.Fs5,f.G5,f.A5,f.B5, f.A5,f.G5,f.Fs5,f.E5, f.D5,f.Cs5,f.B4,f.A4, f.G4,f.A4,f.B4,f.Cs5, f.D5,f.E5,f.Fs5,f.G5, f.Fs5,f.E5,f.D5,f.Cs5, f.B4,f.A4,f.G4,f.Fs4];

                const playlist = [
                    {m:m_intro, b:b_intro}, {m:m_intro, b:b_intro}, 
                    {m:m_A1, b:b_A}, {m:m_A2, b:b_A}, 
                    {m:m_A1, b:b_A}, {m:m_A2, b:b_A}, 
                    {m:m_B1, b:b_B}, {m:m_B1, b:b_B}, 
                    {m:m_B1, b:b_B}, {m:m_B1, b:b_B}, 
                    {m:m_C1, b:b_C1}, {m:m_C2, b:b_C2},
                    {m:m_C1, b:b_C1}, {m:m_C2, b:b_C2}, 
                    {m:m_B1, b:b_B}, {m:m_B1, b:b_B}, 
                    {m:m_A1, b:b_A}, {m:m_A2, b:b_A}, 
                    {m:m_D1, b:b_D}, {m:m_D2, b:b_D}, 
                    {m:m_D1, b:b_D}, {m:m_D2, b:b_D}, 
                    {m:m_E, b:b_A}, {m:m_E, b:b_A}, 
                    {m:m_E, b:b_A}, {m:m_E, b:b_A},
                    {m:m_C1, b:b_C1}, {m:m_C2, b:b_C2}, 
                    {m:m_A1, b:b_A}, {m:m_A2, b:b_A}
                ];

                let tick = 0;
                AudioEngine.musicInterval = setInterval(()=>{
                    let blockIdx = Math.floor(tick / 32) % playlist.length;
                    let step = tick % 32;
                    let block = playlist[blockIdx];
                    
                    let mel = block.m[step];
                    let bas = block.b[step];
                    
                    if(mel !== 0) AudioEngine.playTone(mel, 'square', 0.15, 0.25); 
                    if(bas !== 0) {
                        AudioEngine.playTone(bas, 'sawtooth', 0.2, 0.2); 
                        AudioEngine.playTone(bas/2, 'square', 0.2, 0.15); 
                    }
                    
                    let isIntro = blockIdx < 2;
                    let isSlow = blockIdx >= 18 && blockIdx <= 21; 
                    if(!isIntro) {
                        if(step % 8 === 0) AudioEngine.playTone(50, 'sine', 0.15, 0.5); 
                        if(!isSlow && step % 8 === 4) AudioEngine.noise(0.08, 'snare'); 
                    }
                    tick++;
                }, 125); 
            },
            stopMusic:()=>{if(AudioEngine.musicInterval){clearInterval(AudioEngine.musicInterval);AudioEngine.musicInterval=null;}},
            sfx:{jump:()=>AudioEngine.playTone(150,'sine',0.2,0.1),hit:()=>AudioEngine.playTone(80,'sawtooth',0.1,0.2),slash:()=>AudioEngine.playTone(400,'triangle',0.1,0.05),ui:()=>AudioEngine.playTone(800,'sine',0.05,0.05),unlock:()=>AudioEngine.playTone(1000,'square',0.5,0.1),win:()=>{setTimeout(()=>AudioEngine.playTone(300,'square',0.5,0.1),0);setTimeout(()=>AudioEngine.playTone(500,'square',1.0,0.1),400);},
            warp:()=>AudioEngine.playTone(100,'sawtooth',0.8,0.15),collapse:()=>{AudioEngine.playTone(50,'sawtooth',3.0,0.4);setTimeout(()=>AudioEngine.playTone(40,'square',2.0,0.3),500);},
            roar:()=>{AudioEngine.playTone(60,'sawtooth',3.0,0.5);setTimeout(()=>AudioEngine.playTone(40,'square',2.5,0.6),500);setTimeout(()=>AudioEngine.noise(2.5,'rumble'),1000);}}
        };
        const SFX={ui:AudioEngine.sfx.ui,hover:()=>{},win:AudioEngine.sfx.win, warp:AudioEngine.sfx.warp, collapse:AudioEngine.sfx.collapse, roar:AudioEngine.sfx.roar};
        
        // --- CONSTANTS & GLOBALS ---
        const canvas=document.getElementById('gameCanvas');const ctx=canvas.getContext('2d');
        const TILE=40,COLS=32,ROWS=18,GRAVITY=0.6,FRICTION=0.85,JUMP_FORCE=-15.5,MOVE_SPEED=0.45,MAX_SPEED=3.5; 
        let state='MENU',grid=[],entities=[],mobs=[],bossProjectiles=[],movingPlats=[],particles=[],environmentParticles=[],bgElements=[],menuParticles=[],keys={},mouse={x:0,y:0,down:false},frame=0,currentMap='neon';
        let p1Config={name:'CYBER 01',color:'#06b6d4',helmet:'none',armor:'none',back:'none',weapon:'sword'};
        let p2Config={name:'SLAYER 02',color:'#dc2626',helmet:'none',armor:'none',back:'none',weapon:'katana'};
        let secretAttempts = 0; const SECRET_PASS = "OARRAPFM23122011";
        
        let isCpuMode=false, cpuDifficulty='normal';
        let isCoop=false, wave=1;
        let acidLevel=0, timeScale=1.0, isGameOver=false;
        
        let whiteFlashAlpha = 0;
        let lairDestroyed = false;

        let clashTimer=0, clashBiome='anchor', clashFlashAlpha=0, clashCycleCount=0, isFinalCollapse=false, longTransition=false;
        const CLASH_INTERVAL=900; let sawBlade=null;

        Game={};
        Game.isCinematic = false;
        let cinematicPhase = 0;
        let cinematicTimer = 0;
        Game.cinematicSfxInterval = null;

        const COSMETICS = {helmets:['none','tactical','oni','viking','samurai','skull','cyclops','hood','pilot','demon'],armors:['none','heavy','stealth','knight','nano','juggernaut','cyberninja'],backs:['none','cape','wings','jetpack','battery','spider','halo'],weapons:['sword','katana','scythe','hammer','spear','daggers','laseraxe','whip','fists']};

        // --- MODULES ---
        const Armory={currentPlayer:1,init:()=>{Armory.switchPlayer(1);},switchPlayer:(id)=>{Armory.currentPlayer=id;document.getElementById('tab-p1').className=id===1?'tab-btn flex-1 active-p1':'tab-btn flex-1';document.getElementById('tab-p2').className=id===2?'tab-btn flex-1 active-p2':'tab-btn flex-1';const cfg=id===1?p1Config:p2Config;document.getElementById('arm-name').value=cfg.name;document.getElementById('arm-color').value=cfg.color;document.getElementById('arm-helmet').value=cfg.helmet;document.getElementById('arm-armor').value=cfg.armor;document.getElementById('arm-back').value=cfg.back;document.getElementById('arm-weapon').value=cfg.weapon;Armory.updatePreview();},updateCurrent:()=>{const cfg=Armory.currentPlayer===1?p1Config:p2Config;cfg.name=document.getElementById('arm-name').value;cfg.color=document.getElementById('arm-color').value;cfg.helmet=document.getElementById('arm-helmet').value;cfg.armor=document.getElementById('arm-armor').value;cfg.back=document.getElementById('arm-back').value;cfg.weapon=document.getElementById('arm-weapon').value;Armory.updatePreview();},updatePreview:()=>{const cfg=Armory.currentPlayer===1?p1Config:p2Config;document.getElementById('preview-name-display').innerText=cfg.name;document.getElementById('preview-name-display').style.color=cfg.color;const pCtx=document.getElementById('armory-canvas').getContext('2d');pCtx.clearRect(0,0,500,500);pCtx.save();pCtx.translate(250,250);pCtx.scale(8,8);pCtx.translate(-11,-21);drawCharacterDetailed(pCtx,0,0,true,cfg.color,cfg);pCtx.restore();},randomizeCharacter:(cfg)=>{cfg.helmet=COSMETICS.helmets[Math.floor(Math.random()*COSMETICS.helmets.length)];cfg.armor=COSMETICS.armors[Math.floor(Math.random()*COSMETICS.armors.length)];cfg.back=COSMETICS.backs[Math.floor(Math.random()*COSMETICS.backs.length)];cfg.weapon=COSMETICS.weapons[Math.floor(Math.random()*COSMETICS.weapons.length)];}};

        // --- CLASSES ---
        class SawBlade {
            constructor(x,y){this.x=x*TILE;this.y=y*TILE;this.radius=50;this.angle=0;this.speedX=4;this.minX=10*TILE;this.maxX=22*TILE;}
            update(){this.x+=this.speedX;this.angle+=0.2;if(this.x>this.maxX||this.x<this.minX)this.speedX*=-1;
            entities.forEach(e=>{let dx=(e.x+e.w/2)-this.x;let dy=(e.y+e.h/2)-this.y;if(Math.sqrt(dx*dx+dy*dy)<this.radius+15){e.hit(10, true);e.vx=(dx>0?10:-10);e.vy=-5;}});}
            draw(ctx){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);ctx.fillStyle='#ef4444';ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.beginPath();for(let i=0;i<8;i++){ctx.lineTo(Math.cos(i*Math.PI/4)*this.radius,Math.sin(i*Math.PI/4)*this.radius);ctx.lineTo(Math.cos((i*Math.PI/4)+0.2)*(this.radius-15),Math.sin((i*Math.PI/4)+0.2)*(this.radius-15));}ctx.closePath();ctx.fill();ctx.stroke();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);ctx.fill();ctx.restore();}
        }

        class Boss {
            constructor(wave) {
                this.w = 50; this.h = 80; 
                this.x = 640; this.y = 100;
                this.maxHp = 200 + (wave * 50); 
                this.hp = this.maxHp;
                this.wave = wave;
                this.vx = 0; this.vy = 0;
                this.atkCd = 0; this.projCd = 50;
                this.grounded = false;
                this.recovering = 0;
                this.state = 'active'; 
                
                this.dialogues = {
                    1: ["SISTEMA COMPROMETIDO. ERRADICACI√ìN INICIADA.", "LA CARNE ES FR√ÅGIL. EL METAL ES ETERNO."],
                    2: ["CADA GOLPE SOLO ME HACE M√ÅS FUERTE.", "¬øCREYERON QUE SER√çA TAN F√ÅCIL? PAT√âTICOS."],
                    3: ["S√çENTAN EL VERDADERO PODER DE MI N√öCLEO.", "SUS ARMADURAS NO SERVIR√ÅN CONTRA ESTAS HOJAS."],
                    4: ["SISTEMAS SOBRECARGADOS. PREP√ÅRENSE PARA SU FIN.", "MI AURA CONSUMIR√Å SUS ESPERANZAS."],
                    5: ["¬°ESTA ES MI FORMA PERFECTA! ¬°INCL√çNENSE!", "¬°NING√öN HUMANO PODR√Å DETENER LA NUEVA ERA!"]
                };
                this.dialogueShown = { spawn: false, half: false };
            }
            update() {
                if(this.state === 'hibernating' || this.state === 'waking') {
                    this.vy += GRAVITY;
                    this.y += this.vy;
                    Physics.collideY(this);
                    if(this.state === 'waking' && frame % 4 === 0) {
                        particles.push({x:this.x+Math.random()*this.w, y:this.y+Math.random()*this.h, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, color:'#ef4444', life:40, size:Math.random()*5+2});
                    }
                    return;
                }

                if(this.state === 'dead') {
                    this.vy += GRAVITY;
                    this.y += this.vy;
                    Physics.collideY(this);
                    return;
                }

                if(this.state === 'dying') {
                    this.recovering--;
                    if(frame % 5 === 0) {
                        for(let i=0;i<8;i++) particles.push({
                            x: this.x + Math.random()*this.w, y: this.y + Math.random()*this.h, 
                            vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, 
                            color: ['#ef4444','#fbbf24','#fff'][Math.floor(Math.random()*3)], 
                            life: 60, size: Math.random()*8+2
                        });
                    }
                    if(this.recovering <= 0) {
                        this.state = 'dead';
                        lairDestroyed = true;
                        whiteFlashAlpha = 1.5; 
                        SFX.warp(); 
                        
                        grid[15][7] = 100;
                        grid[15][8] = 100;
                        grid[16][7] = 100;
                        grid[16][8] = 100;
                    }
                    return;
                }

                if(!this.dialogueShown.spawn) {
                    Game.showBossDialogue(this.dialogues[this.wave][0]);
                    this.dialogueShown.spawn = true;
                }

                if (this.recovering > 0) {
                    this.recovering--;
                    if (frame % 10 === 0) {
                        for(let i=0;i<5;i++) particles.push({
                            x: this.x + Math.random()*this.w, y: this.y + Math.random()*this.h, 
                            vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8, 
                            color: ['#ef4444','#fbbf24','#000'][Math.floor(Math.random()*3)], 
                            life: 40, size: Math.random()*5+2
                        });
                    }
                    if (this.recovering === 0) {
                        this.wave++;
                        this.maxHp = 200 + (this.wave * 50); 
                        this.hp = this.maxHp;
                        document.getElementById('coop-wave-hud').innerText = `RONDA ${this.wave}`;
                        this.dialogueShown = { spawn: false, half: false };
                    }
                    return; 
                }

                if(this.hp <= 0 || isGameOver) return;
                
                if(this.hp <= this.maxHp / 2 && !this.dialogueShown.half) {
                    Game.showBossDialogue(this.dialogues[this.wave][1]);
                    this.dialogueShown.half = true;
                }

                let target = entities.find(e => e.hp > 0);
                if(!target) return;

                let dx = (target.x + target.w/2) - (this.x + this.w/2);
                let dist = Math.abs(dx);

                this.vx += Math.sign(dx) * 0.04;
                this.vx *= 0.9;
                this.vy += GRAVITY;
                
                this.x += this.vx; Physics.collideX(this);
                this.y += this.vy; Physics.collideY(this);

                if (this.atkCd > 0) this.atkCd--;
                else if (dist < 80 && Math.abs(target.y - this.y) < 100) {
                    target.hit(20);
                    target.vx = Math.sign(dx) * 15;
                    target.vy = -10;
                    this.atkCd = 100; 
                }

                if (this.wave >= 2) {
                    if (this.projCd > 0) this.projCd--;
                    else {
                        bossProjectiles.push(new BossProjectile(this.x+this.w/2, this.y+this.h/2, target.x, target.y, this.wave));
                        this.projCd = 120 - Math.min((this.wave * 15), 80); 
                    }
                }
            }
            hit(d) {
                if(this.recovering > 0 || this.state === 'dying' || this.state === 'dead' || this.state === 'hibernating' || this.state === 'waking') return; 
                this.hp -= d;
                AudioEngine.sfx.hit();
                for(let i=0;i<5;i++)particles.push({x:this.x+25,y:this.y+40,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,color:'#ef4444',life:20,size:5});
                
                if(this.hp <= 0) {
                    if (this.wave >= 5) {
                        this.state = 'dying';
                        this.recovering = 180; 
                        SFX.collapse();
                    } else {
                        this.recovering = 600; 
                        SFX.collapse(); 
                    }
                }
            }
            draw(ctx) {
                if (this.state === 'dead') {
                    ctx.save();
                    ctx.translate(this.x + this.w/2, this.y + this.h);
                    ctx.rotate(Math.PI/2); 
                    
                    ctx.fillStyle = '#374151';
                    ctx.beginPath(); ctx.moveTo(-20, -70); ctx.lineTo(20, -70); ctx.lineTo(25, -20); ctx.lineTo(20, 0); ctx.lineTo(-20, 0); ctx.lineTo(-25, -20); ctx.fill();
                    
                    ctx.fillStyle = '#111827';
                    ctx.fillRect(-13, -95, 26, 25); 
                    
                    ctx.fillStyle = '#000';
                    ctx.fillRect(-9, -85, 8, 3);
                    ctx.fillRect(1, -85, 8, 3);
                    
                    ctx.restore();
                    return;
                }

                ctx.save();
                let isHibernating = this.state === 'hibernating';
                let isWaking = this.state === 'waking';

                let bx = this.x + (this.recovering > 0 || this.state === 'dying' || isWaking ? (Math.random()-0.5)*8 : 0);
                let by = this.y + (this.recovering > 0 || this.state === 'dying' ? (Math.random()-0.5)*8 : 0);
                
                let hover = Math.sin(frame*0.05)*5; 
                if (isHibernating) hover = 25;
                else if (isWaking) hover = 25 - (cinematicTimer/360)*25;

                if (this.recovering === 0 && (this.state === 'active' || isHibernating || isWaking)) by += hover;

                if (isHibernating) {
                    ctx.filter = 'brightness(0.3) grayscale(0.8)';
                } else if (isWaking) {
                    ctx.filter = `brightness(${0.3 + (cinematicTimer/360)*0.8}) grayscale(${0.8 - (cinematicTimer/360)*0.8})`;
                }

                if(this.wave >= 4 && !isHibernating && !isWaking) {
                    ctx.strokeStyle = '#a855f7'; ctx.lineWidth = 2; ctx.shadowColor = '#a855f7'; ctx.shadowBlur = 10;
                    ctx.beginPath(); ctx.arc(bx+25, by+30, 60 + Math.sin(frame*0.1)*5, 0, Math.PI*2); ctx.stroke();
                    ctx.shadowBlur = 0;
                }

                ctx.fillStyle = this.wave >= 4 ? '#0f172a' : '#1f2937'; 
                ctx.beginPath(); ctx.moveTo(bx+10, by+10); ctx.lineTo(bx+40, by+10); ctx.lineTo(bx+50, by+30); ctx.lineTo(bx+40, by+80); ctx.lineTo(bx+10, by+80); ctx.lineTo(bx, by+30); ctx.fill();
                
                if(this.wave >= 3) {
                    ctx.fillStyle = '#4b5563';
                    ctx.fillRect(bx-10, by+20, 20, 8); 
                    ctx.fillRect(bx+40, by+20, 20, 8); 
                    ctx.fillStyle = '#ef4444'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 15;
                    ctx.fillRect(bx-15, by-10, 5, 40); 
                    ctx.fillRect(bx+60, by-10, 5, 40); 
                    ctx.shadowBlur = 0;
                }

                if(this.wave >= 5 && !isHibernating) {
                    ctx.fillStyle = '#ef4444'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 10;
                    for(let i=0;i<3;i++) ctx.fillRect(bx+15 + i*10, by-40, 5, 10); 
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.4)';
                    ctx.beginPath(); ctx.moveTo(bx, by+20); ctx.lineTo(bx-40, by-20); ctx.lineTo(bx-20, by+40); ctx.fill(); 
                    ctx.beginPath(); ctx.moveTo(bx+50, by+20); ctx.lineTo(bx+90, by-20); ctx.lineTo(bx+70, by+40); ctx.fill(); 
                    ctx.shadowBlur = 0;
                }

                ctx.fillStyle = '#ef4444';
                ctx.beginPath(); ctx.arc(bx+25, by+40, 8, 0, Math.PI*2); ctx.fill();
                
                ctx.fillStyle = '#111827';
                ctx.fillRect(bx+12, by-15, 26, 25);
                ctx.fillRect(bx+5, by-10, 7, 15); ctx.fillRect(bx+38, by-10, 7, 15); 
                
                if(this.wave >= 2) {
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath(); ctx.moveTo(bx+12, by-15); ctx.lineTo(bx+5, by-30); ctx.lineTo(bx+18, by-15); ctx.fill();
                    ctx.beginPath(); ctx.moveTo(bx+38, by-15); ctx.lineTo(bx+45, by-30); ctx.lineTo(bx+32, by-15); ctx.fill();
                }

                ctx.fillStyle = '#ef4444'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.moveTo(bx+14, by-5); ctx.lineTo(bx+22, by-2); ctx.lineTo(bx+14, by); ctx.fill();
                ctx.beginPath(); ctx.moveTo(bx+36, by-5); ctx.lineTo(bx+28, by-2); ctx.lineTo(bx+36, by); ctx.fill();
                ctx.shadowBlur = 0;

                if (this.recovering === 0 && this.state === 'active') {
                    ctx.fillStyle = '#7f1d1d';
                    ctx.fillRect(this.x, this.y - 30, this.w, 6);
                    ctx.fillStyle = '#ef4444';
                    ctx.fillRect(this.x, this.y - 30, this.w * (this.hp/this.maxHp), 6);
                }
                ctx.restore();
            }
        }

        class BossProjectile {
            constructor(x,y,tx,ty, wave) {
                this.x = x; this.y = y;
                let angle = Math.atan2(ty - y, tx - x);
                let speed = 1.0 + wave*0.2; 
                this.vx = Math.cos(angle)*speed;
                this.vy = Math.sin(angle)*speed;
                this.life = 200;
            }
            update() {
                this.x += this.vx; this.y += this.vy; this.life--;
                entities.forEach(e => {
                    if(e.hp > 0 && Math.abs(this.x - e.x) < 25 && Math.abs(this.y - e.y) < 25) {
                        e.hit(15); 
                        this.life = 0; 
                    }
                });
            }
            draw(ctx) {
                if(this.life <= 0) return;
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Math.atan2(this.vy, this.vx));
                ctx.fillStyle = '#ef4444'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 15;
                ctx.beginPath(); ctx.ellipse(0, 0, 15, 3, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.ellipse(0, 0, 8, 1.5, 0, 0, Math.PI*2); ctx.fill();
                ctx.restore();
            }
        }

        class Player{
            constructor(id,x,y,cfg,isCpu=false){
                this.id=id;this.x=x;this.y=y;this.config=cfg;this.isCpu=isCpu;
                this.w=22;this.h=42;this.vx=0;this.vy=0;this.hp=100;this.grounded=false;this.facingRight=id===1;this.stun=0;this.atkCd=0;this.animFrame=0;this.climbing=false;
                this.respawnTimer=0; this.deadX=0; this.deadY=0;
                this.invul=0; 
                this.shieldHp=0; this.shieldCd=0;
                // En modo P2P, si soy el jugador local uso mis controles, si no, ignoro teclado
                let soyLocal = (NetP2P.activo && ((NetP2P.esHost && id===1) || (!NetP2P.esHost && id===2))) || (!NetP2P.activo && id===1);
                let ctrlP1 = {l:'a',r:'d',u:'w',d:'s',atk:' '};
                let ctrlP2 = {l:'arrowleft',r:'arrowright',u:'arrowup',d:'arrowdown',atk:'enter'};
                this.ctrl = soyLocal ? ctrlP1 : (NetP2P.activo ? {} : ctrlP2);
                this.ai={l:false,r:false,u:false,d:false,atk:false};
            }
            update(){
                if(this.invul > 0) this.invul--;
                if(this.shieldCd > 0) this.shieldCd--;

                if(this.hp<=0){
                    if(isCoop && this.respawnTimer > 0) {
                        this.respawnTimer--;
                        if(this.respawnTimer === 0) {
                            this.hp = 100; this.x = this.deadX; this.y = this.deadY;
                            this.vx = 0; this.vy = 0; this.stun = 30; this.invul = 60; 
                            for(let i=0;i<20;i++)particles.push({x:this.x+11,y:this.y+20,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,color:'#0ff',life:40,size:4});
                            Game.updateUI();
                        }
                    }
                    return;
                }
                
                if(isGameOver) { this.stun = 10; }
                if(this.isCpu && !isGameOver) this.computeAI();
                
                let curGrav=GRAVITY, curSpeed=MOVE_SPEED;
                
                if(currentMap==='time') { curSpeed *= timeScale; curGrav *= timeScale; } 
                if(currentMap==='sky') { curGrav=0.3; this.vx+=0.02; } 
                if(cpuDifficulty==='hard' && this.isCpu) curSpeed*=1.2;
                if(currentMap==='clash') {
                    if(clashBiome==='void_c') curGrav=0.3;
                    if(clashBiome==='neon_c') curSpeed*=1.5;
                    if(clashBiome==='glacier_c') curSpeed*=1.2;
                }

                let inLava=Physics.checkLava(this);
                let onLadder=Physics.checkLadder(this);
                if(onLadder && (this.getInput('u')||this.getInput('d'))) this.climbing=true;
                if(!onLadder) this.climbing=false;

                // Solo el jugador que controla el teclado o la CPU mueve el personaje.
                // En modo P2P, el enemigo se actualiza por la red, as√≠ que ignoramos f√≠sicas de inputs para √©l.
                let soyLocal = (!NetP2P.activo) || (NetP2P.activo && ((NetP2P.esHost && this.id===1) || (!NetP2P.esHost && this.id===2)));

                if(this.stun<=0 && soyLocal){
                    if(!Game.isCinematic) {
                        if(this.getInput('l')){this.vx-=curSpeed;this.facingRight=false;this.animFrame++;}
                        if(this.getInput('r')){this.vx+=curSpeed;this.facingRight=true;this.animFrame++;}
                        if(this.climbing){
                            this.vx*=0.5;this.vy=0;
                            if(this.getInput('u')){let cx=Math.floor((this.x+this.w/2)/TILE), cy=Math.floor(this.y/TILE); if(grid[cx]&&grid[cx][cy]!==6){this.vy=JUMP_FORCE;this.climbing=false;this.grounded=false;}else this.vy=-3;}
                            if(this.getInput('d'))this.vy=3; this.grounded=true;
                        } else {
                            if(this.getInput('u')){if(this.grounded){this.vy=JUMP_FORCE;this.grounded=false;AudioEngine.sfx.jump();this.spawnJumpDust();}else if(inLava){this.vy=-7;AudioEngine.sfx.jump();}}
                            
                            if(this.getInput('d') && this.shieldHp <= 0 && this.shieldCd <= 0) {
                                this.shieldHp = 3;
                                AudioEngine.sfx.unlock();
                                for(let i=0;i<15;i++) particles.push({x:this.x+11, y:this.y+21, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, color:this.config.color, life:30, size:2});
                            }
                        }
                        if(this.getInput('atk')&&this.atkCd<=0)this.attack();
                    }
                } else if(this.stun>0) this.stun--;

                if(this.atkCd>0)this.atkCd--;
                
                // En P2P, las f√≠sicas locales aplican para evitar lag, pero el control lo dicta la red.
                if(inLava){this.vx*=0.6;this.vy*=0.6;if(frame%30===0)this.hit(2, true);}
                else if(!this.climbing){this.vy+=curGrav;this.vx*=FRICTION;}
                
                if(currentMap==='acid' && this.y+this.h > acidLevel) { this.hit(0.5, true); this.vy*=0.5; this.vx*=0.5; }

                let curMax = MAX_SPEED * (currentMap==='time' ? timeScale : 1.0);
                this.vx=Math.max(Math.min(this.vx,curMax*1.5),-curMax*1.5);
                this.x+=this.vx; Physics.collideX(this); this.y+=this.vy; Physics.collideY(this);
                Physics.checkSpikes(this); if(this.y>750)this.hit(100, true); 

                if (currentMap === 'boss_lair' && lairDestroyed) {
                    let cx = Math.floor((this.x + this.w/2) / TILE);
                    let cy = Math.floor((this.y + this.h/2) / TILE);
                    if (grid[cx] && grid[cx][cy] === 100) Game.endGame(0, true); 
                }

                // EMISOR P2P: Solo el due√±o del personaje manda su posici√≥n al otro por internet
                if (NetP2P.activo && soyLocal && state === 'GAME') {
                    NetP2P.conn.send({ 
                        type: 'move',
                        x: this.x, 
                        y: this.y,
                        animFrame: this.animFrame,
                        facingRight: this.facingRight
                    });
                }
            }
            getInput(k){if(this.isCpu)return this.ai[k]; return this.ctrl[k] ? keys[this.ctrl[k]] : false;}
            computeAI(){
                let aggr=0.15, delay=5;
                if(cpuDifficulty==='easy'){aggr=0.02;delay=20;} if(cpuDifficulty==='hard'){aggr=0.9;delay=0;}
                if(frame%(delay+1)!==0 && cpuDifficulty!=='hard')return;
                this.ai={l:false,r:false,u:false,d:false,atk:false};
                let target=entities.find(e=>e.id!==this.id);
                if(!target||target.hp<=0)return;
                let dx=(target.x+target.w/2)-(this.x+this.w/2);
                let dy=target.y-this.y;
                if(Math.abs(dx)>50){ if(dx>0)this.ai.r=true; else this.ai.l=true; }
                if(target.y<this.y-60&&this.grounded&&Math.abs(dx)<200)this.ai.u=true;
                if((this.ai.r||this.ai.l)&&Math.abs(this.vx)<0.2&&this.grounded)this.ai.u=true;
                if(Math.random()<aggr*0.1&&this.grounded)this.ai.u=true;
                if(this.y>600)this.ai.u=true;
                if(Math.abs(dx)<90&&Math.abs(dy)<60){this.facingRight=dx>0; if(this.atkCd<=0&&Math.random()<aggr)this.ai.atk=true;}
                if(this.shieldCd <= 0 && Math.random() < 0.01 && Math.abs(dx) < 150) this.ai.d=true;
            }
            spawnJumpDust(){for(let i=0;i<5;i++)particles.push({x:this.x+10,y:this.y+40,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5),color:'#fff',life:15,size:Math.random()*3});}
            attack(){
                this.atkCd=40;AudioEngine.sfx.slash();let range=70;let hx=this.facingRight?this.x+this.w:this.x-range;
                particles.push({x:hx+(this.facingRight?0:range),y:this.y+20,color:this.config.color,life:10,size:2,isSlash:true});
                
                entities.forEach(e=>{
                    if(e.id!==this.id && e.hp>0 && hx<e.x+e.w && hx+range>e.x && Math.abs(this.y-e.y)<50){
                        if(isCoop) return; 
                        e.hit(10); e.vx=this.facingRight?8:-8; e.vy=-6;
                    }
                });
                
                mobs.forEach((m,i)=>{
                    if(hx<m.x+m.w && hx+range>m.x && Math.abs(this.y-m.y)<80){
                        m.hit(20);
                        if(m.hp<=0 && typeof m.wave === 'undefined') mobs.splice(i,1); 
                    }
                });
            }
            hit(dmg, bypassShield=false){
                if(this.hp<=0 || this.invul>0) return; 
                
                if(!bypassShield && this.shieldHp > 0) {
                    this.shieldHp--;
                    this.invul = 10; 
                    AudioEngine.sfx.hit();
                    for(let i=0;i<10;i++) particles.push({x:this.x+11, y:this.y+21, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, color:'#fff', life:20, size:3});
                    if(this.shieldHp <= 0) this.shieldCd = 300; 
                    return;
                }

                AudioEngine.sfx.hit();
                this.hp-=dmg;
                this.stun=15;
                this.invul=20; 
                for(let i=0;i<8;i++)particles.push({x:this.x+11,y:this.y+20,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,color:this.config.color,life:25,size:3});
                Game.updateUI();
                if(this.hp<=0){
                    if(isCoop) {
                        let alive = entities.filter(e => e.hp>0);
                        if(alive.length === 0) Game.endGame(2); 
                        else {
                            this.respawnTimer = 600; 
                            this.deadX = this.x; this.deadY = this.y - 20; 
                        }
                    } else {
                        Game.endGame(this.id===1?2:1);
                    }
                }
            }
            draw(ctx){
                if(this.hp<=0) {
                    if(isCoop && this.respawnTimer > 0 && this.respawnTimer <= 180) { 
                        ctx.save();
                        ctx.globalAlpha = 0.5 + Math.sin(frame*0.2)*0.2;
                        ctx.fillStyle = '#0ff'; ctx.fillRect(this.deadX, this.deadY, this.w, this.h);
                        ctx.fillStyle = '#fff'; ctx.font = '10px Orbitron'; ctx.textAlign = 'center';
                        ctx.fillText("REBOOT: " + Math.ceil(this.respawnTimer/60) + "s", this.deadX+11, this.deadY - 5);
                        ctx.restore();
                        if(frame%5===0) particles.push({x:this.deadX+Math.random()*this.w, y:this.deadY+this.h, vx:0, vy:-Math.random()*2, color:'#0ff', life:30, size:2});
                    }
                    return;
                }
                
                if(this.invul > 0 && frame % 4 < 2) return; 

                if(this.shieldHp > 0) {
                    ctx.save();
                    ctx.translate(this.x+11, this.y+21);
                    let pulse = Math.sin(frame*0.1)*3;
                    ctx.beginPath();
                    ctx.arc(0, 0, 30 + pulse, 0, Math.PI*2);
                    ctx.fillStyle = this.config.color;
                    ctx.globalAlpha = this.shieldHp * 0.15;
                    ctx.fill();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#fff';
                    ctx.globalAlpha = this.shieldHp * 0.3;
                    ctx.stroke();
                    ctx.restore();
                }
                
                drawCharacterDetailed(ctx,this.x,this.y,this.facingRight,this.config.color,this.config,this.animFrame,this.atkCd);
            }
        }

        class MovingPlat { constructor(x,y,dx,dy,speed,range){this.start={x:x*TILE,y:y*TILE};this.x=this.start.x;this.y=this.start.y;this.w=TILE*3;this.h=15;this.dx=dx;this.dy=dy;this.speed=speed;this.range=range*TILE;} update(){let s=Math.sin(frame*this.speed);this.x=this.start.x+this.dx*s*this.range;this.y=this.start.y+this.dy*s*this.range;} draw(ctx){
            if(currentMap==='clash'){ ctx.fillStyle=Math.random()>0.9?'#f00':'#4a044e'; ctx.fillRect(this.x,this.y,this.w,this.h); }
            else if(currentMap==='boss_lair') { 
                if (lairDestroyed) { ctx.fillStyle='#1f2937';ctx.fillRect(this.x,this.y,this.w,this.h);ctx.fillStyle='#374151';ctx.fillRect(this.x,this.y,this.w,3); }
                else { ctx.fillStyle='#991b1b';ctx.fillRect(this.x,this.y,this.w,this.h);ctx.fillStyle='#ef4444';ctx.fillRect(this.x,this.y,this.w,3); }
            }
            else if(currentMap==='neon') { ctx.fillStyle='#0f172a';ctx.fillRect(this.x,this.y,this.w,this.h);ctx.fillStyle='#06b6d4';ctx.fillRect(this.x,this.y,this.w,2); }
            else { ctx.fillStyle='#64748b';ctx.fillRect(this.x,this.y,this.w,this.h);ctx.fillStyle='#94a3b8';ctx.fillRect(this.x,this.y,this.w,3);ctx.fillStyle='#334155';ctx.fillRect(this.x,this.y+12,this.w,3); }
        }}

        function drawCharacterDetailed(ctx,x,y,facingRight,color,config,animFrame=0,atkCd=0){
            ctx.save(); ctx.translate(x+11,y+21); if(!facingRight)ctx.scale(-1,1);
            let breath=Math.sin(frame*0.05)*1, walk=Math.sin(animFrame*0.3)*4, armRot=atkCd>25?-50+(40-atkCd)*2:(Math.sin(frame*0.05)*5);
            let renderColor = config.rgb ? `hsl(${frame*2},100%,60%)` : color;
            if(config.back==='cape'){let flow=Math.sin(frame*0.2)*3;ctx.fillStyle=renderColor;ctx.globalAlpha=0.6;ctx.beginPath();ctx.moveTo(-6,-12+breath);ctx.lineTo(-16+flow,25+walk+flow);ctx.lineTo(-2+flow,25-walk+flow);ctx.lineTo(6,-12+breath);ctx.fill();ctx.globalAlpha=1;}
            else if(config.back==='wings'){ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=15;ctx.globalAlpha=0.6;let wingFlap=Math.sin(frame*0.1)*5;ctx.beginPath();ctx.moveTo(-4,-10+breath);ctx.quadraticCurveTo(-25+wingFlap,-40,-35+wingFlap,10);ctx.quadraticCurveTo(-15,-10,-4,0+breath);ctx.fill();ctx.shadowBlur=0;ctx.globalAlpha=1;}
            else if(config.back==='jetpack'){ctx.fillStyle='#475569';ctx.fillRect(-12,-12+breath,8,20);ctx.fillStyle='#334155';ctx.fillRect(-10,-8+breath,4,12);ctx.fillStyle=renderColor;ctx.fillRect(-11,-2+breath,2,2);}
            else if(config.back==='battery'){ctx.fillStyle='#334155';ctx.fillRect(-10,-12+breath,6,20);ctx.fillStyle=renderColor;ctx.fillRect(-9,-10+breath,4,16);ctx.fillStyle='white';ctx.globalAlpha=0.5;ctx.fillRect(-8,-10+breath,2,16);ctx.globalAlpha=1;}
            else if(config.back==='spider'){ctx.strokeStyle='#334155';ctx.lineWidth=2; for(let i=0;i<4;i++){let dy=i*5; ctx.beginPath();ctx.moveTo(-5,-5+dy+breath);ctx.lineTo(-20, -10+dy+breath+Math.sin(frame*0.1+i)*5);ctx.stroke();}}
            else if(config.back==='halo'){ctx.strokeStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(0,-35+breath*2,10,3,0,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;}
            ctx.fillStyle='#0f172a';ctx.beginPath();ctx.moveTo(-5,-2);ctx.lineTo(-7,15);ctx.lineTo(-3,15);ctx.lineTo(-1,-2);ctx.fill();ctx.beginPath();ctx.moveTo(1,-2);ctx.lineTo(-1+walk,15);ctx.lineTo(3+walk,15);ctx.lineTo(5,-2);ctx.fill();
            ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-6+walk,8,4,2);ctx.fillRect(-1-walk*0.5,8,4,2);ctx.shadowBlur=0;
            ctx.fillStyle='#1e293b';ctx.beginPath();ctx.moveTo(-8,-12+breath);ctx.lineTo(8,-12+breath);ctx.lineTo(6,2);ctx.lineTo(-6,2);ctx.fill();
            if(config.armor==='heavy'){ctx.fillStyle='#334155'; ctx.fillRect(-9,-10+breath,18,10); ctx.fillStyle=renderColor; ctx.fillRect(-4,-6+breath,8,4);} 
            else if(config.armor==='stealth'){ctx.strokeStyle=renderColor; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(-6,-8+breath); ctx.lineTo(0,2+breath); ctx.lineTo(6,-8+breath); ctx.stroke();} 
            else if(config.armor==='knight'){ctx.fillStyle='#475569'; ctx.fillRect(-10,-11+breath,20,12); ctx.fillStyle=renderColor;ctx.beginPath(); ctx.moveTo(-12,-12+breath); ctx.lineTo(-8,-14+breath); ctx.lineTo(-8,-8+breath); ctx.fill();ctx.beginPath(); ctx.moveTo(12,-12+breath); ctx.lineTo(8,-14+breath); ctx.lineTo(8,-8+breath); ctx.fill();ctx.fillRect(-5,-9+breath,10,6);} 
            else if(config.armor==='nano'){ctx.fillStyle='#1e293b'; ctx.fillRect(-7,-10+breath,14,10);ctx.strokeStyle=renderColor; ctx.globalAlpha=0.5; ctx.lineWidth=1; ctx.beginPath();ctx.moveTo(-4,-8+breath); ctx.lineTo(0,-10+breath); ctx.lineTo(4,-8+breath);ctx.moveTo(-4,-4+breath); ctx.lineTo(0,-6+breath); ctx.lineTo(4,-4+breath);ctx.moveTo(0,-2+breath); ctx.lineTo(0,2+breath); ctx.stroke(); ctx.globalAlpha=1;} 
            else if(config.armor==='juggernaut'){ctx.fillStyle='#111827'; ctx.fillRect(-11,-12+breath,22,16); ctx.fillStyle=renderColor; ctx.fillRect(-5,-8+breath,10,8);}
            else if(config.armor==='cyberninja'){ctx.fillStyle='#000'; ctx.beginPath();ctx.moveTo(-8,-12+breath);ctx.lineTo(0,0+breath);ctx.lineTo(8,-12+breath);ctx.fill(); ctx.strokeStyle=renderColor; ctx.stroke();}
            else {ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-5,-8+breath,10,6);ctx.shadowBlur=0;}
            ctx.fillStyle='#f1f5f9';ctx.beginPath();ctx.arc(0,-17+breath,6,0,Math.PI*2);ctx.fill();
            if(config.helmet==='tactical'){ctx.fillStyle='#0f172a';ctx.beginPath();ctx.moveTo(-7,-19+breath);ctx.lineTo(7,-19+breath);ctx.lineTo(7,-24+breath);ctx.lineTo(4,-26+breath);ctx.lineTo(-4,-26+breath);ctx.lineTo(-7,-24+breath);ctx.fill();ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-5,-19+breath,10,3);ctx.shadowBlur=0;}
            else if(config.helmet==='oni'){ctx.fillStyle='#991b1b';ctx.beginPath();ctx.arc(0,-17+breath,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.moveTo(-4,-22+breath);ctx.lineTo(-6,-28+breath);ctx.lineTo(-2,-24+breath);ctx.moveTo(4,-22+breath);ctx.lineTo(6,-28+breath);ctx.lineTo(2,-24+breath);ctx.fill();}
            else if(config.helmet==='viking'){ctx.fillStyle='#334155';ctx.fillRect(-7,-22+breath,14,6);ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=8;ctx.beginPath();ctx.moveTo(-7,-20+breath);ctx.lineTo(-12,-30+breath);ctx.lineTo(-9,-22+breath);ctx.moveTo(7,-20+breath);ctx.lineTo(12,-30+breath);ctx.lineTo(9,-22+breath);ctx.fill();ctx.shadowBlur=0;}
            else if(config.helmet==='samurai'){ctx.fillStyle='#1e293b';ctx.beginPath();ctx.arc(0,-18+breath,8,Math.PI,0);ctx.fill();ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.arc(0,-24+breath,6,0,Math.PI,true);ctx.fill();}
            else if(config.helmet==='skull'){ctx.fillStyle='#f1f5f9';ctx.beginPath();ctx.arc(0,-18+breath,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-4,-19+breath,3,3);ctx.fillRect(1,-19+breath,3,3);ctx.fillRect(-2,-14+breath,4,2);}
            else if(config.helmet==='cyclops'){ctx.fillStyle='#334155';ctx.beginPath();ctx.arc(0,-18+breath,8,0,Math.PI*2);ctx.fill();ctx.fillStyle=renderColor;ctx.shadowBlur=5;ctx.shadowColor=renderColor;ctx.beginPath();ctx.arc(0,-18+breath,3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
            else if(config.helmet==='hood'){ctx.fillStyle='#333'; ctx.beginPath();ctx.arc(0,-18+breath,9,Math.PI,0);ctx.lineTo(9,-10+breath);ctx.lineTo(-9,-10+breath);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-5,-18+breath,10,4);}
            else if(config.helmet==='pilot'){ctx.fillStyle='#334155';ctx.beginPath();ctx.arc(0,-18+breath,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fbbf24';ctx.fillRect(-6,-20+breath,12,6);}
            else if(config.helmet==='demon'){ctx.fillStyle='#7f1d1d';ctx.beginPath();ctx.arc(0,-17+breath,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.moveTo(-5,-22+breath);ctx.lineTo(-10,-35+breath);ctx.lineTo(0,-25+breath);ctx.moveTo(5,-22+breath);ctx.lineTo(10,-35+breath);ctx.lineTo(0,-25+breath);ctx.fill();}
            ctx.save();ctx.translate(0,-9+breath);ctx.rotate(armRot*Math.PI/180);ctx.fillStyle=renderColor;ctx.beginPath();ctx.arc(0,0,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#1e293b';ctx.fillRect(-2,0,4,10);
            if(config.weapon==='scythe'){ctx.fillStyle='#0f172a';ctx.fillRect(-1,6,2,30);ctx.fillStyle='#94a3b8';ctx.beginPath();ctx.moveTo(0,6);ctx.quadraticCurveTo(25,0,30,15);ctx.lineTo(25,18);ctx.quadraticCurveTo(20,8,0,10);ctx.fill();ctx.strokeStyle=renderColor;ctx.lineWidth=2;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.beginPath();ctx.moveTo(0,6);ctx.quadraticCurveTo(25,0,30,15);ctx.stroke();ctx.shadowBlur=0;}
            else if(config.weapon==='katana'){ctx.fillStyle='#000';ctx.fillRect(-1,8,2,8);ctx.fillStyle='#fff';ctx.beginPath();ctx.moveTo(0,16);ctx.quadraticCurveTo(3,30,1,45);ctx.lineTo(-1,45);ctx.quadraticCurveTo(1,30,-1,16);ctx.fill();ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.fillRect(-3,14,6,2);ctx.shadowBlur=0;}
            else if(config.weapon==='hammer'){ctx.fillStyle='#5d4037';ctx.fillRect(-2,6,4,24);ctx.fillStyle='#334155';ctx.fillRect(-8,4,16,10);ctx.strokeStyle=renderColor;ctx.lineWidth=2;ctx.strokeRect(-8,4,16,10);}
            else if(config.weapon==='spear'){ctx.fillStyle='#5d4037';ctx.fillRect(-1,6,2,36);ctx.fillStyle='#94a3b8';ctx.beginPath();ctx.moveTo(0,42);ctx.lineTo(-3,36);ctx.lineTo(3,36);ctx.fill();ctx.fillStyle=renderColor;ctx.fillRect(-1,36,2,4);}
            else if(config.weapon==='daggers'){ctx.fillStyle='#334155';ctx.fillRect(-4,8,2,6);ctx.fillStyle=renderColor;ctx.fillRect(-4,14,2,10);ctx.fillStyle='#334155';ctx.fillRect(2,8,2,6);ctx.fillStyle=renderColor;ctx.fillRect(2,14,2,10);}
            else if(config.weapon==='laseraxe'){ctx.fillStyle='#333';ctx.fillRect(-2,6,4,20); ctx.fillStyle=renderColor; ctx.shadowColor=renderColor;ctx.shadowBlur=10; ctx.beginPath();ctx.moveTo(-10,10);ctx.lineTo(10,10);ctx.lineTo(15,25);ctx.lineTo(-15,25);ctx.fill(); ctx.shadowBlur=0;}
            else if(config.weapon==='whip'){ctx.strokeStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=5;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,6);ctx.quadraticCurveTo(10,20,-5,30);ctx.stroke(); ctx.shadowBlur=0;}
            else if(config.weapon==='fists'){ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.fillRect(-4,10,8,8);ctx.shadowBlur=0;}
            else{ctx.fillStyle='#334155';ctx.fillRect(-3,12,6,2);ctx.fillStyle=renderColor;ctx.shadowColor=renderColor;ctx.shadowBlur=10;ctx.fillRect(-1.5,14,3,24);ctx.shadowBlur=0;ctx.globalAlpha=0.7;ctx.fillStyle='white';ctx.fillRect(-0.5,14,1,24);ctx.globalAlpha=1;}
            ctx.restore();ctx.restore();
        }

        const Physics={
            collideX:(e)=>{let l=Math.floor(e.x/TILE),r=Math.floor((e.x+e.w-0.01)/TILE),t=Math.floor(e.y/TILE),b=Math.floor((e.y+e.h-0.01)/TILE);if(e.vx>0&&(Physics.solid(r,t)||Physics.solid(r,b))){e.x=r*TILE-e.w-0.01;e.vx=0;}else if(e.vx<0&&(Physics.solid(l,t)||Physics.solid(l,b))){e.x=(l+1)*TILE+0.01;e.vx=0;}},
            collideY:(e)=>{let l=Math.floor(e.x/TILE),r=Math.floor((e.x+e.w-0.01)/TILE),t=Math.floor(e.y/TILE),b=Math.floor((e.y+e.h-0.01)/TILE);if(e.vy>0){if(Physics.solid(l,b)||Physics.solid(r,b)){e.y=b*TILE-e.h-0.01;e.vy=0;e.grounded=true;return;}let fp=e.y-e.vy+e.h;if((Physics.plat(l,b)||Physics.plat(r,b))&&fp<=b*TILE+10){e.y=b*TILE-e.h-0.01;e.vy=0;e.grounded=true;return;}for(let mp of movingPlats){if(e.x+e.w>mp.x&&e.x<mp.x+mp.w&&fp>=mp.y-10&&fp<=mp.y+20){e.y=mp.y-e.h;e.vy=0;e.grounded=true;return;}}}else if(e.vy<0&&(Physics.solid(l,t)||Physics.solid(r,t))){e.y=(t+1)*TILE+0.01;e.vy=0;}e.grounded=false;},
            checkLava:(e)=>{let cx=Math.floor((e.x+e.w/2)/TILE),fy=Math.floor((e.y+e.h)/TILE);return (grid[cx]&&grid[cx][fy]===5);},
            checkSpikes:(e)=>{let cx=Math.floor((e.x+e.w/2)/TILE),fy=Math.floor((e.y+e.h)/TILE);if(grid[cx]&&grid[cx][fy]>=30 && grid[cx][fy]<100){e.hit(15, true);e.vy=-10;}},
            checkLadder:(e)=>{let cx=Math.floor((e.x+e.w/2)/TILE);let cy=Math.floor((e.y+e.h/2)/TILE);return (grid[cx]&&grid[cx][cy]===6);},
            solid:(x,y)=>x>=0&&x<COLS&&y>=0&&y<ROWS&&(grid[x][y]===1||grid[x][y]===9), plat:(x,y)=>x>=0&&x<COLS&&y>=0&&y<ROWS&&grid[x][y]===4
        };

        Game.init=()=>{
            Armory.init(); Game.loadMap('neon');
            window.addEventListener('keydown',e=>{let k=e.key.toLowerCase();if(e.code==='Space')k=' ';keys[k]=true;});
            window.addEventListener('keyup',e=>{let k=e.key.toLowerCase();if(e.code==='Space')k=' ';keys[k]=false;});
            canvas.addEventListener('mousedown',e=>{AudioEngine.start();mouse.down=true;});
            canvas.addEventListener('contextmenu',e=>e.preventDefault());
            window.addEventListener('mouseup',()=>mouse.down=false);
            
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            if(isTouch) {
                document.getElementById('mobile-controls').classList.remove('hidden');
                const bindBtn = (id, key) => {
                    const el = document.getElementById(id);
                    el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; AudioEngine.start(); });
                    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
                }
                bindBtn('m-up', 'w'); bindBtn('m-left', 'a'); bindBtn('m-right', 'd'); 
                bindBtn('m-shield', 's'); bindBtn('m-atk', ' ');
            }

            Game.loop();
        };

        Game.loop=()=>{frame++;
            if(state==='GAME') {
                if(Game.isCinematic) {
                    cinematicTimer++;
                    if(cinematicPhase === 1) {
                        let targets = [340, 220]; 
                        let allInPosition = true;
                        
                        entities.forEach((p, i) => {
                            let target = targets[i];
                            if(p.x < target) {
                                p.x += 0.5; 
                                p.facingRight = true; p.animFrame++; p.grounded = true;
                                allInPosition = false;
                            } else {
                                p.animFrame = 0;
                            }
                        });
                        
                        if(allInPosition && cinematicTimer > 540) {
                            cinematicPhase = 2; cinematicTimer = 0;
                            mobs[0].state = 'waking';
                            SFX.roar();
                            Game.showBossDialogue("INTRUSOS DETECTADOS... DESPERTANDO.");
                        }
                    } else if(cinematicPhase === 2) {
                        if(cinematicTimer > 360) {
                            Game.isCinematic = false;
                            mobs[0].state = 'active';
                            mobs[0].dialogueShown.spawn = true; 
                            setTimeout(() => {
                                Game.showBossDialogue("SISTEMA COMPROMETIDO. ERRADICACI√ìN INICIADA.");
                                AudioEngine.playBossMusic();
                            }, 500);
                        }
                    }
                }

                if(currentMap==='clash' && !isFinalCollapse) {
                    clashTimer++;
                    let timeLeft=Math.ceil((CLASH_INTERVAL-clashTimer)/60);
                    document.getElementById('clash-timer-hud').innerText=`CAMBIO: ${timeLeft}s`;
                    if(clashCycleCount>=4){document.getElementById('final-warning').classList.remove('hidden'); document.getElementById('clash-timer-hud').style.color='red';}
                    if(clashTimer>=CLASH_INTERVAL) Game.triggerClashShift();
                }
                if(sawBlade) sawBlade.update();
                if(currentMap==='acid') { acidLevel = 650 + Math.sin(frame*0.01)*40; } 
                
                if(currentMap==='time') { 
                    let phase = Math.floor(frame / 900) % 3; 
                    if (phase === 0) timeScale = 0.5; 
                    else if (phase === 1) timeScale = 1.5; 
                    else timeScale = 1.0; 
                }
            }

            ctx.save();
            if(Game.isCinematic && cinematicPhase === 2) {
                let shake = (cinematicTimer / 360) * 12; 
                ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
            }

            Renderer.drawBackground(currentMap);
            Renderer.drawMap();
            
            if(state==='GAME'||state==='SELECT'||state==='EDITOR'){
                entities.forEach(e=>{e.update();e.draw(ctx);});
                mobs.forEach(m=>{m.update();m.draw(ctx);});
                bossProjectiles.forEach(p=>{p.update();p.draw(ctx);});
                Renderer.drawParticles();
                Renderer.drawEnvParticles();
                if(sawBlade) sawBlade.draw(ctx);
            }
            
            ctx.restore();

            if(currentMap==='acid'){ ctx.fillStyle='rgba(34, 197, 94, 0.6)'; ctx.fillRect(0, acidLevel, 1280, 720-acidLevel); }
            
            if(currentMap==='time' && state==='GAME') {
                ctx.font = '24px Orbitron'; ctx.textAlign = 'center'; ctx.shadowBlur = 10;
                if(timeScale === 0.5) { ctx.fillStyle = '#a855f7'; ctx.shadowColor = '#a855f7'; ctx.fillText('ANOMAL√çA: TIEMPO LENTO', 640, 50); }
                else if(timeScale === 1.5) { ctx.fillStyle = '#ef4444'; ctx.shadowColor = '#ef4444'; ctx.fillText('ANOMAL√çA: TIEMPO ACELERADO', 640, 50); }
                else { ctx.fillStyle = '#10b981'; ctx.shadowColor = '#10b981'; ctx.fillText('ESTABILIDAD TEMPORAL NORMAL', 640, 50); }
                ctx.shadowBlur = 0;
            }

            if(whiteFlashAlpha > 0){
                ctx.fillStyle=`rgba(255,255,255,${Math.min(1, whiteFlashAlpha)})`;
                ctx.fillRect(0,0,1280,720);
                whiteFlashAlpha -= 0.01;
            }
            
            if(clashFlashAlpha>0){
                ctx.fillStyle=`rgba(255,255,255,${clashFlashAlpha})`;ctx.fillRect(0,0,1280,720);
                clashFlashAlpha-=(longTransition?0.005:0.02);
            }
            if(state==='SELECT') { ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(0,0,1280,720); }
            requestAnimationFrame(Game.loop);
        };
        
        Game.showBossDialogue=(txt)=>{
            let el = document.getElementById('boss-dialogue');
            el.innerText = "ULTRON: " + txt;
            el.classList.remove('hidden');
            clearTimeout(Game.dialogueTimeout);
            Game.dialogueTimeout = setTimeout(() => el.classList.add('hidden'), 4000);
        };

        Game.triggerClashShift=()=>{
            clashTimer=0; clashCycleCount++;
            Armory.randomizeCharacter(p1Config); Armory.randomizeCharacter(p2Config);
            if(clashCycleCount===0) Game.loadClashLevel('anchor');
            else if(clashCycleCount>=5) { isFinalCollapse=true;longTransition=true;clashFlashAlpha=1.0;SFX.collapse();document.getElementById('final-warning').classList.add('hidden');document.getElementById('clash-timer-hud').innerText="COLAPSO TOTAL"; Game.loadClashLevel('final_collapse'); }
            else { longTransition=false;clashFlashAlpha=1.0;SFX.warp();let biomes=['magma_c','forest_c','neon_c','void_c','glacier_c'];let next=biomes[Math.floor(Math.random()*biomes.length)];while(next===clashBiome)next=biomes[Math.floor(Math.random()*biomes.length)]; Game.loadClashLevel(next); }
        };

        Game.showScreen=(id)=>{document.querySelectorAll('.ui-screen,#editor-hud,#game-hud,#victory-screen').forEach(e=>e.classList.add('hidden'));if(id)document.getElementById(id).classList.remove('hidden');};
        
        Game.goToMenu=()=>{
            Game.showScreen('menu-screen');state='MENU';entities=[];mobs=[];bossProjectiles=[];
            Game.loadMap('neon');
            AudioEngine.stopMusic && AudioEngine.stopMusic();
            AudioEngine.stopAmbient && AudioEngine.stopAmbient();
            if(Game.cinematicInterval) clearInterval(Game.cinematicInterval);
            if(Game.cinematicSfxInterval) clearInterval(Game.cinematicSfxInterval);
        };
        Game.goToCustom=()=>{Game.showScreen('custom-screen'); Armory.updatePreview();};
        Game.goToSelect=()=>{Game.showScreen('select-screen');state='SELECT';Game.previewMap('neon');};
        
        Game.startPvPMode=()=>{isCpuMode=false; isCoop=false; p2Config.name="SLAYER 02"; document.getElementById('cpu-difficulty-panel').classList.add('hidden'); Game.goToSelect();};
        Game.startCpuMode=()=>{isCpuMode=true; isCoop=false; p2Config.name="NEXUS AI"; document.getElementById('cpu-difficulty-panel').classList.remove('hidden'); Game.setDifficulty('normal'); Game.goToSelect();};
        
        Game.openCoopModal=()=>{
            SFX.ui();
            document.getElementById('coop-modal').classList.add('active');
        };
        
        Game.startCinematic=()=>{
            SFX.ui();
            document.getElementById('coop-modal').classList.remove('active');
            Game.showScreen('cinematic-screen');
            
            AudioEngine.stopAmbient();
            AudioEngine.noise(15, 'wind');
            if(Game.cinematicSfxInterval) clearInterval(Game.cinematicSfxInterval);
            Game.cinematicSfxInterval = setInterval(() => { AudioEngine.noise(2, 'rumble'); }, 3000);
            
            const text = "SISTEMA COMPROMETIDO...\n\nLA INTELIGENCIA ARTIFICIAL 'ULTRON' HA TOMADO EL CONTROL DEL N√öCLEO DE LA TIERRA.\n\nSU DIRECTRIZ PRINCIPAL: ERRADICAR TODA VIDA ORG√ÅNICA.\n\nUSTEDES SON LA √öLTIMA L√çNEA DE DEFENSA.\nDESTRUYAN SU N√öCLEO, O EL MUNDO PERECER√Å EN CENIZAS.";
            const el = document.getElementById('cinematic-text');
            el.innerHTML = "";
            let i = 0;
            
            if(Game.cinematicInterval) clearInterval(Game.cinematicInterval);
            Game.cinematicInterval = setInterval(() => {
                if(i < text.length) {
                    let char = text.charAt(i);
                    el.innerHTML += char === '\n' ? '<br>' : char;
                    if(char !== ' ' && char !== '\n' && i % 3 === 0) {
                        AudioEngine.playTone(800, 'square', 0.05, 0.02);
                    }
                    i++;
                } else {
                    clearInterval(Game.cinematicInterval);
                }
            }, 40);
        };
        
        Game.skipCinematic=()=>{
            SFX.ui();
            if(Game.cinematicInterval) clearInterval(Game.cinematicInterval);
            if(Game.cinematicSfxInterval) clearInterval(Game.cinematicSfxInterval);
            AudioEngine.stopAmbient(); 
            document.getElementById('cinematic-screen').classList.add('hidden');
            Game.startVisualCinematic();
        };

        Game.startVisualCinematic=()=>{
            isCpuMode=false; isCoop=true; p2Config.name="PLAYER 2";
            Game.loadMap('boss_lair');
            state='GAME'; isGameOver = false; bossProjectiles = []; mobs = []; timeScale = 1.0; frame=0;
            whiteFlashAlpha = 0; lairDestroyed = false;
            document.getElementById('boss-dialogue').classList.add('hidden');
            document.getElementById('clash-timer-hud').style.opacity=0;document.getElementById('clash-mode-hud').style.opacity=0;document.getElementById('final-warning').classList.add('hidden');sawBlade=null;

            document.getElementById('coop-wave-hud').classList.remove('hidden'); wave=1;
            let boss = new Boss(wave);
            boss.state = 'hibernating';
            mobs=[boss];

            entities=[new Player(1, 80, 600, p1Config), new Player(2, 40, 600, p2Config)];

            Game.updateUI();
            document.getElementById('p1-name-hud').innerText=p1Config.name; document.getElementById('p2-name-hud').innerText=p2Config.name;
            document.getElementById('coop-wave-hud').innerText=`RONDA ${wave}`;
            document.getElementById('winner-name').style.fontSize = "";
            document.getElementById('winner-name').style.color = "";

            Game.showScreen('game-hud');
            Game.isCinematic = true;
            cinematicPhase = 1;
            cinematicTimer = 0;
        };

        Game.setDifficulty=(level)=>{cpuDifficulty=level; document.querySelectorAll('.btn-diff').forEach(b=>b.className='btn-diff'); document.getElementById('diff-'+level).classList.add('active-'+level); p2Config.name=level==='easy'?"BOT CADETE":level==='normal'?"BOT SOLDADO":"BOT PESADILLA"; SFX.ui();};
        
        Game.showToast=(msg)=>{
            const t = document.getElementById('toast-msg');
            t.innerText = msg; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        };
        
        Game.pendingMap= '';
        Game.confirmMap=(t)=>{ SFX.ui(); Game.pendingMap = t; document.getElementById('mode-modal').classList.add('active'); };
        
        // INTERCEPTOR: Si hay conexi√≥n online, manda se√±al de inicio al cliente
        Game.startSelectedMap=()=>{ 
            document.getElementById('mode-modal').classList.remove('active'); 
            if(NetP2P.activo && NetP2P.esHost) {
                NetP2P.conn.send({ type: 'startMap', mapa: Game.pendingMap });
            }
            Game.loadMap(Game.pendingMap); 
            Game.startGame(); 
        };

        Game.startGame=()=>{
            Game.showScreen('game-hud'); state='GAME'; isGameOver = false; bossProjectiles = []; mobs = []; timeScale = 1.0; frame=0;
            whiteFlashAlpha = 0; lairDestroyed = false; 
            document.getElementById('boss-dialogue').classList.add('hidden');

            if(!isCoop) entities=[new Player(1,100,200,p1Config), new Player(2,1100,200,p2Config, isCpuMode)];
            else { entities=[new Player(1,200,200,p1Config), new Player(2,280,200,p2Config)]; }
            
            Game.updateUI();
            document.getElementById('p1-name-hud').innerText=p1Config.name; document.getElementById('p2-name-hud').innerText=p2Config.name;
            
            if(currentMap==='clash'){clashTimer=0;clashBiome='anchor';clashCycleCount=0;isFinalCollapse=false;sawBlade=null;document.getElementById('clash-timer-hud').style.opacity=1;document.getElementById('clash-mode-hud').style.opacity=1;document.getElementById('final-warning').classList.add('hidden');}
            else {document.getElementById('clash-timer-hud').style.opacity=0;document.getElementById('clash-mode-hud').style.opacity=0;document.getElementById('final-warning').classList.add('hidden');sawBlade=null;}
            
            if(isCoop) { document.getElementById('coop-wave-hud').classList.remove('hidden'); wave=1; mobs=[new Boss(wave)]; document.getElementById('coop-wave-hud').innerText=`RONDA ${wave}`; }
            else document.getElementById('coop-wave-hud').classList.add('hidden');

            document.getElementById('winner-name').style.fontSize = "";
            document.getElementById('winner-name').style.color = "";
        };
        Game.restartGame=()=>{document.getElementById('victory-screen').classList.add('hidden');if(currentMap==='clash')Game.loadMap('clash');else Game.loadMap(currentMap);Game.startGame();};
        Game.saveAndExit=()=>{Game.goToMenu();};
        Game.updateUI=()=>{
            if(entities.length<2)return;
            let hp1=Math.max(0,entities[0].hp), hp2=Math.max(0,entities[1].hp);
            document.getElementById('hp-bar-1').style.width=hp1+'%';document.getElementById('hp-txt-1').innerText=Math.ceil(hp1)+'%';
            document.getElementById('hp-bar-2').style.width=hp2+'%';document.getElementById('hp-txt-2').innerText=Math.ceil(hp2)+'%';
            
            document.getElementById('hp-txt-1').style.color = hp1===0 ? '#ef4444' : '';
            document.getElementById('hp-txt-2').style.color = hp2===0 ? '#ef4444' : '';
        };
        
        // MODALES
        Game.openSecretModal=()=>{ document.getElementById('secret-modal').classList.add('active'); secretAttempts=0; document.getElementById('secret-pass').value=''; document.getElementById('secret-hint').innerText=''; };
        Game.closeSecretModal=()=>{ document.getElementById('secret-modal').classList.remove('active'); };
        Game.openUpdateModal=()=>{ document.getElementById('update-modal').classList.add('active'); };
        Game.checkSecret=()=>{
            let val=document.getElementById('secret-pass').value.toUpperCase();
            if(val===SECRET_PASS){SFX.win();document.getElementById('btn-secret-level').outerHTML=`<button onmouseenter="Game.previewMap('destruction'); SFX.hover()" onclick="SFX.ui(); Game.confirmMap('destruction')" class="w-full text-left p-5 bg-slate-900/80 hover:bg-orange-900/60 border border-orange-700 hover:border-orange-500 rounded-lg transition-all"><div class="font-bold text-xl text-orange-500">TON-618 ABYSS</div></button>`;Game.closeSecretModal();}
            else{secretAttempts++;document.getElementById('secret-hint').innerText="PISTA: "+SECRET_PASS.substring(0,secretAttempts)+"...";AudioEngine.sfx.hit();}
        };

        Game.loadMap=(t)=>{
            currentMap=t;
            if(t==='clash'){Game.loadClashLevel('anchor');return;}
            grid=new Array(COLS).fill(0).map(()=>new Array(ROWS).fill(0));movingPlats=[];bgElements=[];environmentParticles=[];sawBlade=null;
            for(let i=0;i<COLS;i++){grid[i][0]=9;grid[i][ROWS-1]=9;}for(let i=0;i<ROWS;i++){grid[0][i]=9;grid[COLS-1][i]=9;}
            
            if(t==='boss_lair'){
                for(let x=1;x<31;x++)grid[x][17]=1; 
                for(let x=4;x<10;x++)grid[x][13]=1; 
                for(let x=22;x<28;x++)grid[x][13]=1; 
                grid[14][9]=4; grid[15][9]=4; grid[16][9]=4; grid[17][9]=4; 
                movingPlats.push(new MovingPlat(12, 14, 1, 0, 0.02, 5)); 
            }
            else if(t==='magma'){for(let x=1;x<31;x++)grid[x][16]=(x>9&&x<22)?5:1;for(let x=2;x<9;x++)grid[x][13]=1;for(let x=23;x<30;x++)grid[x][13]=1;movingPlats.push(new MovingPlat(9,14,0,1,0.02,-7));movingPlats.push(new MovingPlat(21,14,0,1,0.02,-7));for(let x=12;x<20;x++)grid[x][10]=1;for(let x=8;x<24;x++)grid[x][4]=1;}
            else if(t==='neon'){
                for(let i=0;i<40;i++)bgElements.push({x:i*40, w:20+Math.random()*40, h:50+Math.random()*300, c:Math.random()>0.5?'#1e1b4b':'#312e81'});
                for(let x=0;x<32;x++) grid[x][17]=1; 
                for(let x=2;x<8;x++) grid[x][14]=4; 
                for(let x=24;x<30;x++) grid[x][14]=4; 
                for(let x=12;x<20;x++) grid[x][11]=4; 
                for(let x=6;x<12;x++) grid[x][8]=4; 
                for(let x=20;x<26;x++) grid[x][8]=4; 
                movingPlats.push(new MovingPlat(14,15, 1, 0, 0.02, 4)); 
                grid[0][16]=1; grid[31][16]=1;
            }
            else if(t==='forest'){
                for(let i=0;i<20;i++)bgElements.push({x:Math.random()*1280,h:200+Math.random()*200});
                for(let x=1;x<31;x++)grid[x][16]=1;for(let y=10;y<16;y++){grid[6][y]=1;grid[5][y]=6;}grid[4][10]=4;grid[5][10]=4;grid[6][10]=4;grid[7][10]=4;for(let y=8;y<16;y++){grid[25][y]=1;grid[26][y]=6;}grid[23][8]=4;grid[24][8]=4;grid[25][8]=4;grid[26][8]=4;movingPlats.push(new MovingPlat(12,12,1,0,0.015,4));
            }
            else if(t==='sky'){ 
                for(let i=0; i<8; bgElements.push({x:Math.random()*1280, y:Math.random()*400, s:0.5+Math.random(), w:80+Math.random()*120}), i++);
                for(let x=2;x<30;x+=3)grid[x][15]=1; for(let x=5;x<27;x+=5)grid[x][10]=4; movingPlats.push(new MovingPlat(10,5,1,0,0.02,5)); 
            }
            else if(t==='acid'){ 
                for(let x=0;x<32;x++)grid[x][17]=1; 
                for(let x=2;x<8;x++)grid[x][14]=1;  
                for(let x=24;x<30;x++)grid[x][14]=1; 
                grid[10][11]=1; grid[11][11]=1; grid[20][11]=1; grid[21][11]=1; 
                grid[14][11]=4; grid[15][11]=4; grid[16][11]=4; grid[17][11]=4; 
                grid[8][13]=4; grid[9][13]=4; grid[22][13]=4; grid[23][13]=4; 
                movingPlats.push(new MovingPlat(14,8,1,0,0.03,6)); 
            }
            else if(t==='time'){ 
                for(let i=0; i<12; bgElements.push({x:Math.random()*1280, y:Math.random()*720, r:20+Math.random()*50, s:(Math.random()-0.5)*0.05, teeth: 8+Math.floor(Math.random()*10)}), i++);
                for(let x=2;x<30;x++)grid[x][16]=1; for(let x=12;x<20;x++)grid[x][12]=1; grid[5][10]=4; grid[26][10]=4; 
            }
            else if(t==='glacier'){for(let x=1;x<31;x++)grid[x][17]=1;for(let x=10;x<22;x++)grid[x][14]=1;for(let x=12;x<20;x++)grid[x][11]=1;for(let x=14;x<18;x++)grid[x][8]=1;movingPlats.push(new MovingPlat(2,12,1,0,0.02,3));movingPlats.push(new MovingPlat(26,12,-1,0,0.02,3));}
            else if(t==='destruction'){for(let x=1;x<31;x++)grid[x][16]=(x%3===0)?5:1;for(let x=5;x<12;x++)grid[x][13]=1;for(let x=20;x<27;x++)grid[x][13]=1;movingPlats.push(new MovingPlat(10,7,1,0.5,0.03,8));for(let x=8;x<24;x++)if(x%2===0)grid[x][5]=4;}
            else if(t==='void'){
                for(let i=0; i<100; bgElements.push({x:Math.random()*1280, y:Math.random()*720, s:Math.random()*2+1}), i++);
                for(let x=10;x<22;x++)grid[x][15]=1;for(let x=4;x<8;x++)grid[x][12]=1;for(let x=24;x<28;x++)grid[x][12]=1;for(let x=14;x<18;x++)grid[x][9]=4;movingPlats.push(new MovingPlat(2,8,1,0,0.02,5));movingPlats.push(new MovingPlat(26,8,-1,0,0.02,5));
            }
        };

        Game.loadClashLevel=(subType)=>{
            clashBiome=subType;
            let txtHud=document.getElementById('clash-mode-hud');
            grid=new Array(COLS).fill(0).map(()=>new Array(ROWS).fill(0));movingPlats=[];bgElements=[];environmentParticles=[];sawBlade=null;
            for(let i=0;i<COLS;i++){grid[i][0]=9;grid[i][ROWS-1]=9;}for(let i=0;i<ROWS;i++){grid[0][i]=9;grid[COLS-1][i]=9;}
            
            if(state==='GAME') entities.forEach(e=>{if(e.y>600){e.y=100;e.vy=0;}}); 

            if(subType==='final_collapse'){
                txtHud.innerText="ESTADO: COLAPSO TOTAL"; txtHud.style.color='#b91c1c';
                for(let x=1;x<31;x++)grid[x][17]=5; 
                grid[3][13]=1;grid[4][13]=1;grid[5][13]=1; grid[26][13]=1;grid[27][13]=1;grid[28][13]=1;
                for(let x=8;x<24;x++) grid[x][12]=1; 
                grid[8][12]=30; grid[23][12]=30; 
                sawBlade=new SawBlade(16,8);
                entities[0].x=10*TILE; entities[0].y=10*TILE;
                entities[1].x=21*TILE; entities[1].y=10*TILE;
            }
            else if(subType==='anchor'){ txtHud.innerText="ESTADO: NEXUS CERO"; txtHud.style.color='#fbbf24'; for(let x=2;x<30;x++)if(x<12||x>19)grid[x][15]=1; for(let x=14;x<18;x++)grid[x][12]=1; movingPlats.push(new MovingPlat(12,8,0,1,0.03,4)); }
            else if(subType==='magma_c'){ txtHud.innerText="ESTADO: FUEGO FATUO"; txtHud.style.color='#818cf8'; for(let x=1;x<31;x++)grid[x][17]=(x%3===0)?5:1; for(let x=2;x<30;x+=4)grid[x][12]=1; grid[15][8]=1;grid[16][8]=1; movingPlats.push(new MovingPlat(2,5,1,0,0.08,15)); }
            else if(subType==='forest_c'){ txtHud.innerText="ESTADO: FOREST DECAY"; txtHud.style.color='#57534e'; for(let x=1;x<31;x++)if(x%5!==0)grid[x][16]=1; for(let x=5;x<27;x+=7){grid[x][15]=6;grid[x][14]=6;grid[x][13]=6;} movingPlats.push(new MovingPlat(12,6,0,1,0.02,3)); }
            else if(subType==='neon_c'){ txtHud.innerText="ESTADO: SYSTEM FAILURE"; txtHud.style.color='#ef4444'; for(let y=2;y<16;y+=2){grid[4][y]=1;grid[27][y]=1;} for(let x=8;x<24;x++)grid[x][16]=1; movingPlats.push(new MovingPlat(10,10,1,0,0.1,5)); movingPlats.push(new MovingPlat(20,5,-1,0,0.1,5)); }
            else if(subType==='void_c'){ txtHud.innerText="ESTADO: GRAVEDAD LUNAR"; txtHud.style.color='#a855f7'; grid[4][14]=1;grid[5][14]=1; grid[26][14]=1;grid[27][14]=1; grid[15][10]=1;grid[16][10]=1; movingPlats.push(new MovingPlat(14,5,0,1,0.02,4)); }
            else if(subType==='glacier_c'){ txtHud.innerText="ESTADO: MELTDOWN"; txtHud.style.color='#0ea5e9'; for(let x=1;x<31;x+=3)grid[x][16]=1; for(let x=8;x<24;x+=4)grid[x][10]=1; movingPlats.push(new MovingPlat(5,12,1,0,0.05,5)); }
        };
        Game.previewMap=(t)=>{Game.loadMap(t);document.getElementById('preview-title').innerText=t.toUpperCase();};
        
        Game.endGame=(winnerId, isCoopWin = false)=>{
            if(state!=='GAME')return; 
            isGameOver = true; 
            AudioEngine.stopMusic && AudioEngine.stopMusic();
            AudioEngine.sfx.win();
            document.getElementById('victory-screen').classList.remove('hidden');
            
            if(isCoopWin) {
                document.getElementById('vic-title').innerText = "¬°AMENAZA NEUTRALIZADA!";
                document.getElementById('winner-name').innerText = "PR√ìXIMAMENTE M√ÅS VILLANOS";
                document.getElementById('winner-name').style.fontSize = "4rem";
                document.getElementById('winner-name').style.color = "#22c55e"; 
            } else if(isCoop) {
                document.getElementById('vic-title').innerText = "GAME OVER";
                document.getElementById('winner-name').innerText = "RONDAS SOBREVIVIDAS: " + (wave - 1);
                document.getElementById('winner-name').style.fontSize = "4rem";
                document.getElementById('winner-name').style.color = "#ef4444"; 
            } else {
                document.getElementById('vic-title').innerText = "¬°VICTORIA!";
                document.getElementById('winner-name').innerText=entities[winnerId-1].config.name;
                document.getElementById('winner-name').style.color=entities[winnerId-1].config.color;
            }
        };
        
        const Renderer={
            drawBackground:(t)=>{
                const g=ctx.createLinearGradient(0,0,0,720);
                if(t==='clash'){
                    let colorBase='#fff', isBroken=clashBiome==='final_collapse', isAnchor=clashBiome==='anchor';
                    if(isBroken){ctx.fillStyle='#000';ctx.fillRect(0,0,1280,720); colorBase='#991b1b';}
                    else if(isAnchor){ctx.fillStyle='#f8fafc';ctx.fillRect(0,0,1280,720); colorBase='#fbbf24';}
                    else{ctx.fillStyle='#000';ctx.fillRect(0,0,1280,720); if(clashBiome==='magma_c')colorBase='#818cf8'; if(clashBiome==='forest_c')colorBase='#78716c'; if(clashBiome==='neon_c')colorBase='#ef4444'; if(clashBiome==='void_c')colorBase='#a855f7'; if(clashBiome==='glacier_c')colorBase='#0ea5e9';}
                    
                    if(isBroken){ctx.beginPath();ctx.arc(640,360,150,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();ctx.strokeStyle='#ef4444';ctx.lineWidth=3;ctx.stroke(); if(frame%2===0)environmentParticles.push({x:Math.random()*1280,y:-50,vx:0,vy:15,life:80,c:'#ef4444',s:14,binary:true});}
                    else if(isAnchor){let zp=ctx.createRadialGradient(640,360,10,640,360,400);zp.addColorStop(0,'#fff');zp.addColorStop(0.5,'#fbbf24');zp.addColorStop(1,'#f8fafc');ctx.fillStyle=zp;ctx.fillRect(0,0,1280,720); ctx.strokeStyle='rgba(0,0,0,0.1)';ctx.lineWidth=1;for(let i=0;i<1280;i+=40){ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,720);ctx.stroke();}}
                    else {let zp=ctx.createRadialGradient(640,360,10,640,360,200+Math.sin(frame*0.1)*30);zp.addColorStop(0,'#fff');zp.addColorStop(0.2,colorBase);zp.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=zp;ctx.beginPath();ctx.arc(640,360,200+Math.sin(frame*0.1)*30,0,Math.PI*2);ctx.fill();if(frame%4===0)environmentParticles.push({x:640,y:360,vx:(Math.random()-0.5)*15,vy:(Math.random()-0.5)*15,life:60,c:colorBase,s:12,binary:true});}
                }
                else if(state==='MENU'){g.addColorStop(0,'#0f172a');g.addColorStop(1,'#1e1b4b');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);if(frame%2===0)menuParticles.push({x:Math.random()*1280,y:720,vx:(Math.random()-0.5)*2,vy:-(Math.random()*3+2),life:Math.random()*40+20,color:`hsl(${Math.random()*40},100%,50%)`,size:Math.random()*6+2});for(let i=menuParticles.length-1;i>=0;i--){let p=menuParticles[i];p.x+=p.vx;p.y+=p.vy;p.life--;p.size*=0.96;ctx.fillStyle=p.color;ctx.globalAlpha=p.life/60;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;if(p.life<=0)menuParticles.splice(i,1);}}
                else if(t==='sky'){
                    g.addColorStop(0,'#bae6fd');g.addColorStop(1,'#f0f9ff');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720); 
                    bgElements.forEach(c => { 
                        c.x += c.s * timeScale; if(c.x > 1280) c.x = -c.w; 
                        ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.beginPath(); 
                        ctx.arc(c.x, c.y, c.w/3, 0, Math.PI*2); ctx.arc(c.x+c.w/3, c.y-20, c.w/2, 0, Math.PI*2); ctx.arc(c.x+c.w/1.5, c.y, c.w/3, 0, Math.PI*2); 
                        ctx.fill(); 
                    });
                    if(frame%5===0)environmentParticles.push({x:0,y:Math.random()*720,vx:10*timeScale,vy:0,life:100,c:'#fff',s:5, type:'wind'});
                }
                else if(t==='acid'){
                    g.addColorStop(0,'#064e3b');g.addColorStop(1,'#022c22');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720); 
                    ctx.fillStyle='#0f172a'; ctx.fillRect(300, 0, 80, 720); ctx.fillRect(900, 0, 60, 720); 
                    if(frame%4===0) environmentParticles.push({x:Math.random()*1280, y:720, vx:(Math.random()-0.5), vy:-(Math.random()*3+2), c:'rgba(34, 197, 94, 0.4)', s:Math.random()*15+5, life:150, type:'bubble'});
                }
                else if(t==='time'){
                    g.addColorStop(0,'#0f172a');g.addColorStop(1,'#000');
                    ctx.fillStyle=g;ctx.fillRect(0,0,1280,720); 
                    
                    bgElements.forEach(bg => {
                        ctx.save(); ctx.translate(bg.x, bg.y); ctx.rotate(frame*bg.s * timeScale); 
                        ctx.fillStyle='#1e293b'; ctx.beginPath(); ctx.arc(0,0,bg.r,0,Math.PI*2); ctx.fill();
                        ctx.strokeStyle='#334155'; ctx.lineWidth=10;
                        for(let i=0; i<bg.teeth; i++) { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(i*Math.PI*2/bg.teeth)*(bg.r+10), Math.sin(i*Math.PI*2/bg.teeth)*(bg.r+10)); ctx.stroke(); }
                        ctx.fillStyle='#020617'; ctx.beginPath(); ctx.arc(0,0,bg.r*0.4,0,Math.PI*2); ctx.fill();
                        ctx.restore();
                    });

                    ctx.save(); ctx.translate(250, 450); ctx.rotate(0.2);
                    ctx.fillStyle = '#1e293b'; ctx.fillRect(-50, -200, 100, 400); 
                    ctx.fillStyle = '#fde047'; ctx.beginPath(); ctx.arc(0, -100, 30, 0, Math.PI*2); ctx.fill(); 
                    ctx.fillStyle = '#000'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(0,-100); ctx.lineTo(Math.cos(frame*0.01)*15,-100+Math.sin(frame*0.01)*15); ctx.moveTo(0,-100); ctx.lineTo(Math.cos(frame*0.005)*10,-100+Math.sin(frame*0.005)*10); ctx.stroke();
                    ctx.restore();
                    
                    ctx.save(); ctx.translate(1000, 500); ctx.rotate(-0.15);
                    ctx.fillStyle = '#0f172a'; ctx.fillRect(-60, -300, 120, 600); 
                    ctx.fillStyle = '#fde047'; ctx.beginPath(); ctx.arc(0, -200, 40, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#000'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(0,-200); ctx.lineTo(Math.cos(frame*0.02)*20,-200+Math.sin(frame*0.02)*20); ctx.moveTo(0,-200); ctx.lineTo(0,-225); ctx.stroke();
                    ctx.restore();

                    ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.lineWidth=5;ctx.beginPath();ctx.arc(640,360,300,0,Math.PI*2);ctx.stroke();
                    
                    if(frame%15===0) environmentParticles.push({x:Math.random()*1280, y:-20, vx:(Math.random()-0.5)*2, vy:(1+Math.random())*timeScale, text: ['I','II','III','IV','V','VI','IX','X','XII'][Math.floor(Math.random()*9)], life:400, s: 20+Math.random()*20, type:'roman'});
                }
                else if(t==='boss_lair'){
                    if(lairDestroyed) {
                        g.addColorStop(0,'#050505'); g.addColorStop(1,'#0f172a'); 
                        ctx.fillStyle=g; ctx.fillRect(0,0,1280,720);
                        ctx.fillStyle='#020202';
                        for(let i=100; i<1280; i+=300) {
                            ctx.fillRect(i, 0, 80, 720);
                            ctx.fillStyle='#1f2937'; 
                            ctx.fillRect(i+35, 0, 10, 720); 
                            ctx.fillStyle='#020202';
                        }
                        if(frame%5===0)environmentParticles.push({x:Math.random()*1280,y:0,vx:(Math.random()-0.5),vy:1+Math.random()*2,life:120,c:'#4b5563',s:2}); 
                    } else {
                        g.addColorStop(0,'#0a0a0a'); g.addColorStop(1,'#260707'); 
                        ctx.fillStyle=g; ctx.fillRect(0,0,1280,720);
                        ctx.fillStyle='#050505';
                        for(let i=100; i<1280; i+=300) {
                            ctx.fillRect(i, 0, 80, 720);
                            ctx.fillStyle='#991b1b';
                            ctx.globalAlpha = 0.5 + Math.sin(frame*0.05)*0.5; 
                            ctx.fillRect(i+35, 0, 10, 720); 
                            ctx.globalAlpha = 1;
                        }
                        if(frame%3===0)environmentParticles.push({x:Math.random()*1280,y:0,vx:0,vy:2+Math.random()*3,life:100,c:'#ef4444',s:2});
                    }
                }
                else if(t==='magma'){
                    g.addColorStop(0,'#450a0a');g.addColorStop(1,'#0f172a');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);
                    ctx.fillStyle='#1c0b0b';
                    ctx.beginPath(); ctx.moveTo(200, 720); ctx.lineTo(500, 300); ctx.lineTo(700, 300); ctx.lineTo(1000, 720); ctx.fill();
                    ctx.fillStyle='#ea580c';
                    ctx.shadowColor = '#ea580c'; ctx.shadowBlur = 20 + Math.sin(frame*0.1)*10;
                    ctx.beginPath(); ctx.moveTo(550, 300); ctx.lineTo(600, 450); ctx.lineTo(580, 500); ctx.lineTo(650, 600); ctx.lineTo(620, 300); ctx.fill();
                    ctx.shadowBlur = 0;
                    if(frame%2===0)environmentParticles.push({x:Math.random()*1280,y:720,vx:(Math.random()-0.5)*4,vy:-(Math.random()*4+1),life:120,c:Math.random()>0.5?'#9ca3af':'#f97316',s:Math.random()*3+1});
                }
                else if(t==='neon'){
                    g.addColorStop(0,'#0f172a');g.addColorStop(1,'#4c1d95');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);
                    
                    ctx.fillStyle='#f43f5e'; ctx.shadowColor='#f43f5e'; ctx.shadowBlur=50;
                    ctx.beginPath(); ctx.arc(640, 360, 200, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur=0; ctx.fillStyle=g;
                    for(let y=260; y<560; y+=20) ctx.fillRect(400, y, 480, 5 + (y-260)*0.02); 

                    bgElements.forEach(b => {
                        ctx.fillStyle = b.c; ctx.fillRect(b.x, 720-b.h, b.w, b.h);
                        ctx.fillStyle = '#06b6d4'; 
                        if(frame%60 < 30) ctx.fillRect(b.x+b.w/2, 720-b.h+20, 2, 2);
                    });
                    
                    if(frame%2===0)environmentParticles.push({x:Math.random()*1280,y:0,vx:0,vy:10+Math.random()*5,life:80,c:['#06b6d4','#d946ef'][Math.floor(Math.random()*2)],s:2, type:'rain'});
                }
                else if(t==='forest'){
                    g.addColorStop(0,'#022c22');g.addColorStop(1,'#0f172a');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);
                    ctx.fillStyle='#064e3b';
                    bgElements.forEach(tree => { ctx.fillRect(tree.x, 720-tree.h, 40, tree.h); });
                    if(frame%3===0) environmentParticles.push({x:Math.random()*1280,y:Math.random()*720,vx:(Math.random()-0.5),vy:(Math.random()-0.5),life:100,c:'#bef264',s:3, type:'firefly'});
                }
                else if(t==='void'){
                    g.addColorStop(0,'#000');g.addColorStop(1,'#4c1d95');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);
                    bgElements.forEach((star, i) => {
                        ctx.globalAlpha = 0.5 + Math.sin(frame*0.05 + i)*0.5;
                        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(star.x, star.y, star.s, 0, Math.PI*2); ctx.fill();
                    });
                    ctx.globalAlpha = 1;
                }
                else {
                    if(t==='destruction'){ctx.fillStyle='#000';ctx.fillRect(0,0,1280,720);let cg=ctx.createRadialGradient(640,360,50,640,360,500);cg.addColorStop(0,'#000');cg.addColorStop(0.2,'#000');cg.addColorStop(0.25,'#fbbf24');cg.addColorStop(0.4,'#7c2d12');cg.addColorStop(1,'#000');ctx.fillStyle=cg;ctx.beginPath();ctx.arc(640,360,600,0,Math.PI*2);ctx.fill();}
                    else if(t==='glacier'){g.addColorStop(0,'#1e3a8a');g.addColorStop(1,'#bfdbfe');ctx.fillStyle=g;ctx.fillRect(0,0,1280,720);}
                }
            },
            drawMap:()=>{
                let isClash=currentMap==='clash';
                for(let x=0;x<COLS;x++)for(let y=0;y<ROWS;y++){
                    let id=grid[x][y]; if(!id)continue; let px=x*TILE,py=y*TILE;
                    if(isClash && Math.random()>0.99) { px+=(Math.random()-0.5)*8; py+=(Math.random()-0.5)*8; }
                    
                    if(id===1){
                        if(isClash) {
                            if(clashBiome==='final_collapse'){ctx.fillStyle='#000';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#b91c1c';ctx.strokeRect(px,py,TILE,TILE);}
                            else if(clashBiome==='anchor'){ctx.fillStyle='#cbd5e1';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#fff';ctx.strokeRect(px,py,TILE,TILE);}
                            else if(clashBiome==='magma_c'){ctx.fillStyle='#1e1b4b';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#4338ca';ctx.strokeRect(px,py,TILE,TILE);}
                            else if(clashBiome==='forest_c'){ctx.fillStyle='#292524';ctx.fillRect(px,py,TILE,TILE);ctx.fillStyle='#57534e';ctx.fillRect(px,py,TILE,5);}
                            else if(clashBiome==='neon_c'){ctx.fillStyle='#000';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#ef4444';ctx.lineWidth=2;ctx.strokeRect(px+5,py+5,30,30);}
                            else if(clashBiome==='glacier_c'){ctx.fillStyle='#0f172a';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#38bdf8';ctx.strokeRect(px,py,TILE,TILE);}
                            else{ctx.fillStyle='#2e1065';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#d8b4fe';ctx.strokeRect(px+2,py+2,36,36);}
                        }
                        else if(currentMap==='sky'){ctx.fillStyle='#fff';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#7dd3fc';ctx.strokeRect(px,py,TILE,TILE);}
                        else if(currentMap==='acid'){ctx.fillStyle='#3f6212';ctx.fillRect(px,py,TILE,TILE);ctx.fillStyle='#166534';ctx.fillRect(px+5,py+5,30,30);}
                        else if(currentMap==='time'){ctx.fillStyle='#1e1b4b';ctx.fillRect(px,py,TILE,TILE);ctx.fillStyle='#172554';ctx.fillRect(px,py,TILE,5);}
                        else if(currentMap==='boss_lair'){
                            if(lairDestroyed) { ctx.fillStyle='#111';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#374151';ctx.strokeRect(px+2,py+2,36,36); }
                            else { ctx.fillStyle='#111';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#991b1b';ctx.strokeRect(px+2,py+2,36,36); }
                        }
                        else if(currentMap==='destruction'){ctx.fillStyle='#111';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#fbbf24';ctx.strokeRect(px+2,py+2,36,36);}
                        else if(currentMap==='neon'){ctx.fillStyle='#020617';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#06b6d4';ctx.lineWidth=2;ctx.strokeRect(px+2,py+2,36,36);}
                        else if(currentMap==='forest'){ctx.fillStyle='#3f6212';ctx.fillRect(px,py,TILE,TILE);ctx.fillStyle='#4ade80';ctx.fillRect(px,py,TILE,8);}
                        else if(currentMap==='magma'){ctx.fillStyle='#450a0a';ctx.fillRect(px,py,TILE,TILE);ctx.fillStyle='#b91c1c';ctx.fillRect(px+5,py+5,30,30);}
                        else if(currentMap==='glacier'){ctx.fillStyle='rgba(186, 230, 253, 0.5)';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#fff';ctx.strokeRect(px,py,TILE,TILE);}
                        else if(currentMap==='void'){ctx.fillStyle='#2e1065';ctx.fillRect(px,py,TILE,TILE);ctx.strokeStyle='#a855f7';ctx.strokeRect(px,py,TILE,TILE);}
                        else {ctx.fillStyle='#1e293b';ctx.fillRect(px,py,TILE,TILE);ctx.fillStyle='#0f172a';ctx.fillRect(px+4,py+4,32,32);}
                    }
                    else if(id===4){
                        if(currentMap==='neon'){ ctx.fillStyle='#0f172a';ctx.fillRect(px,py,40,10);ctx.fillStyle='#06b6d4';ctx.fillRect(px,py+10,40,2); }
                        else { ctx.fillStyle='#94a3b8';ctx.fillRect(px,py,40,10);ctx.fillStyle='#334155';ctx.fillRect(px,py+10,40,4); }
                    }
                    else if(id===6){ctx.fillStyle='#fbbf24';ctx.fillRect(px+10,py,4,TILE);ctx.fillRect(px+26,py,4,TILE);for(let j=0;j<4;j++)ctx.fillRect(px+10,py+10*j,20,4);}
                    else if(id===5){let w=Math.sin(frame*0.2+x)*3;ctx.fillStyle='#c2410c';ctx.fillRect(px,py+10,40,30);ctx.fillStyle='#ea580c';ctx.beginPath();ctx.moveTo(px,py+10);ctx.quadraticCurveTo(px+20,py+10+w,px+40,py+10);ctx.lineTo(px+40,py+40);ctx.lineTo(px,py+40);ctx.fill();}
                    else if(id>=30 && id < 100)Renderer.drawSpike(px,py,id);
                    else if(id===9){ctx.fillStyle='#000';ctx.fillRect(px,py,40,40);}
                    else if(id===100){ 
                        ctx.fillStyle = '#1e293b'; ctx.fillRect(px, py, TILE, TILE);
                        ctx.fillStyle = '#06b6d4'; ctx.shadowColor = '#06b6d4'; ctx.shadowBlur = 20;
                        ctx.fillRect(px+8, py+5, TILE-16, TILE-10); 
                        ctx.shadowBlur = 0;
                    }
                }
                for(let mp of movingPlats)mp.update(),mp.draw(ctx);
            },
            drawSpike:(x,y,id)=>{ctx.fillStyle='#dc2626';ctx.beginPath();if(id===30){ctx.moveTo(x,y+40);ctx.lineTo(x+20,y);ctx.lineTo(x+40,y+40);}else if(id===31){ctx.moveTo(x,y);ctx.lineTo(x+40,y+20);ctx.lineTo(x,y+40);}else if(id===32){ctx.moveTo(x,y);ctx.lineTo(x+20,y+40);ctx.lineTo(x+40,y);}else{ctx.moveTo(x+40,y);ctx.lineTo(x,y+20);ctx.lineTo(x+40,y+40);}ctx.fill();},
            drawParticles:()=>{for(let i=particles.length-1;i>=0;i--){let p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life--;if(p.isSlash){ctx.strokeStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=10;ctx.lineWidth=2;ctx.beginPath();ctx.arc(p.x,p.y,25,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;}else{ctx.fillStyle=p.color;ctx.globalAlpha=Math.max(0, p.life/30);ctx.fillRect(p.x,p.y,p.size,p.size);ctx.globalAlpha=1;}if(p.life<=0)particles.splice(i,1);}},
            drawEnvParticles:()=>{for(let i=environmentParticles.length-1;i>=0;i--){let p=environmentParticles[i];
                if(p.type==='firefly') { p.x += p.vx + Math.sin(frame*0.05)*2; p.y += p.vy; }
                else p.x+=p.vx; p.y+=p.vy; p.life--;
                
                if(p.binary){ctx.font=`${p.s}px monospace`;ctx.fillStyle=p.c;ctx.globalAlpha=Math.max(0, p.life/60);ctx.fillText(Math.random()>0.5?"1":"0",p.x,p.y);}
                else if(p.type==='roman') {ctx.font=`${p.s}px Orbitron`; ctx.fillStyle='#fde047'; ctx.globalAlpha=Math.max(0, p.life/400); ctx.fillText(p.text, p.x, p.y);}
                else if(p.type==='bubble') {ctx.strokeStyle=p.c; ctx.lineWidth=2; ctx.globalAlpha=Math.max(0, p.life/150); ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.stroke();}
                else if(p.type==='wind') {ctx.fillStyle=p.c; ctx.globalAlpha=Math.max(0, p.life/100); ctx.fillRect(p.x,p.y,p.s*5,p.s*0.2);}
                else{ctx.fillStyle=p.c;ctx.globalAlpha=Math.max(0, p.life/100);ctx.fillRect(p.x,p.y,p.s,p.s);}
                
                ctx.globalAlpha=1;
                if(p.life<=0)environmentParticles.splice(i,1);
            }}
        };
        Game.init();
    </script>
</body>
</html>
